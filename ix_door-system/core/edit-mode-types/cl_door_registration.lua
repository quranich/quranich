-- <|> Hello, fucker | Taxin2012 and PURP was here | Mysterious Zone Project | mzrp.ru <|>
local ix=ix local Color=Color local a=surface.SetFont local b=surface.GetTextSize local c=surface.SetDrawColor local d=surface.DrawRect local derma=derma local e=surface.SetTextColor local f=surface.SetTextPos local g=surface.DrawText local LocalPlayer=LocalPlayer local ScrW=ScrW local ScrH=ScrH local pairs=pairs local istable=istable local isvector=isvector local h=surface.SetMaterial local i=surface.DrawTexturedRect local Vector=Vector local j=render.DrawWireframeBox local IsValid=IsValid local k=table.RemoveByValue local l=table.insert local m=vgui.Create local n=math.floor local RunConsoleCommand=RunConsoleCommand local o=string.TrimLeft local p=timer.Simple local q=sound.Play local DermaMenu=DermaMenu local r=net.Start local s=net.WriteString local t=net.WriteUInt local u=net.WriteTable local v=net.SendToServer local w=ix.plugin.list["door-system"]local x="DOOR_REGISTRATION"local y=1000 local z={".wav",".ogg",".mp3"}local A={["sound_door_action"]="Звук открытия: ",["sound_door_move"]="Звук движения: ",["sound_door_sirena"]="Звук сирены: ",["sound_keypad_access"]="Кейпад успех: ",["sound_keypad_denied"]="Кейпад отказ: ",}local B={["data_door_close"]="Закрытая дверь",["data_door_open"]="Открытая дверь",["data_keypad"]="Кейпад",["data_escape"]="Объект для выхода",}local C=ix.util.GetMaterial("icon16/arrow_in.png")local function D(H,I,J,K,L,M)K=K or"ixSubTitleFont"M=M or 8 L=L or Color(88,88,88,255)a(K)local N,O=b(J)local P,Q=N+M*2,O+M*2 ix.util.DrawBlurAt(H,I,P,Q)c(0,0,0,40)d(H,I,P,Q)derma.SkinFunc("DrawImportantBackground",H,I,P,Q,L)e(color_white)f(H+M,I+M)g(J)return Q end ix.doorsSystem.RegisterEditModeHook(x,"HUDPaint",function(H)local I=LocalPlayer()local J=I:GetPos()local K,L=ScrW(),ScrH()local M=32 local N,O=M,M*1.75 local P=H.stage_edit or 0 O=O+D(N,O,"Редактирование дверей","ui.Tahoma-10",ix.config.Get("color"))if P~=4 then O=O+D(N,O,"ЛКМ - Выбрать обьект","ui.Tahoma-7")end O=O+D(N,O,"ПКМ - Сбросить редактирование","ui.Tahoma-7")if P~=4 then O=O+D(N,O,"RELOAD (Перезарядка) - Отменить редактирование","ui.Tahoma-7")end O=O+10 O=O+D(N,O,"Этап редактирования № "..P,"ui.Tahoma-10",ix.config.Get("color"))if P==0 then O=O+D(N,O,"Выберите дверь - ЗАКРЫТА","ui.Tahoma-7")elseif P==1 then O=O+D(N,O,"Выберите дверь - ОТКРЫТА","ui.Tahoma-7")elseif P==2 then O=O+D(N,O,"Выберите КЕЙПАД","ui.Tahoma-7")elseif P==3 then O=O+D(N,O,"Выберите объект для выхода с закрытого подземелья","ui.Tahoma-7")O=O+D(N,O,"(Должен находиться в подземелье)","ui.Tahoma-6")elseif P==4 then O=O+D(N,O,"Выберите позиции в которые игрок может переместиться","ui.Tahoma-7")O=O+D(N,O,"если застрянет в двери","ui.Tahoma-7")+5 O=O+D(N,O,"ЛКМ - Добавить / Удалить Позицию","ui.Tahoma-7")O=O+D(N,O,"RELOAD (Перезарядка) - Открыть меню завершения","ui.Tahoma-7")end for Q,R in pairs(H)do if istable(R)and isvector(R.data_position)then local S=R.data_position local T=S:ToScreen()local U=16 local V,W=T.x-U*0.5,T.y-U*0.5 c(color_white)h(C)i(V,W,U,U)ix.util.DrawText(B[Q]and B[Q]or Q,T.x,T.y,color_white,TEXT_ALIGN_CENTER,TEXT_ALIGN_TOP,"ui.Tahoma-7",alpha)if Q=="data_escape"then local X=R.data_escape_pos for Y=1,#X do local Z=X[Y]local ab=Z:ToScreen()c(color_white)h(C)i(V,W,U,U)ix.util.DrawText("Позиция выхода",ab.x,ab.y,color_white,TEXT_ALIGN_CENTER,TEXT_ALIGN_TOP,"ui.Tahoma-7",alpha)end end end end end)ix.doorsSystem.RegisterEditModeHook(x,"PostDrawTranslucentRenderables",function(H)local I=5 local J,K=Vector(-I,-I,0),Vector(I,I,I)local L=H.data_escape local M=L.data_escape_pos if istable(M)then for N=1,#M do local O=M[N]j(O,angle_zero,J,K,Color(255,255,255),true)end end end)local function E(H,I)local J=I:GetEyeTraceNoCursor()local K=J.HitPos local L=J.Entity local M=H.stage_edit or 0 if M==0 and IsValid(L)then H.data_door_close={data_entityIndex=L:EntIndex(),data_position=L:GetPos(),data_angles=L:GetAngles(),data_model=L:GetModel(),data_skin=L:GetSkin(),data_material=L:GetMaterial(),data_color=L:GetColor(),}H.stage_edit=M+1 elseif M==1 and IsValid(L)then H.data_door_open={data_entityIndex=L:EntIndex(),data_position=L:GetPos(),data_angles=L:GetAngles(),}H.stage_edit=M+1 elseif M==2 and IsValid(L)then local N=H.data_keypad.level or 1 H.data_keypad={level=N,data_entityIndex=L:EntIndex(),data_position=L:GetPos(),data_angles=L:GetAngles(),data_model=L:GetModel(),data_skin=L:GetSkin(),data_material=L:GetMaterial(),data_color=L:GetColor(),}H.stage_edit=M+1 elseif M==3 and IsValid(L)then H.data_escape={data_entityIndex=L:EntIndex(),data_position=L:GetPos(),data_angles=L:GetAngles(),data_model=L:GetModel(),data_skin=L:GetSkin(),data_material=L:GetMaterial(),data_color=L:GetColor(),data_escape_pos={},}H.stage_edit=M+1 elseif M==4 then local N=H.data_escape local O=N.data_escape_pos local P=false for Q=1,#O do local R=O[Q]if isvector(R)and K:DistToSqr(R)<=75 then k(O,R)P=true break end end if P==false then l(O,K)end end end local function F(H,I)local J=H.editable_index local K=H.data_keypad.level or 1 ix.doorsSystem_editmode.reading_data={editable_index=J,data_door_close={},data_door_open={},data_keypad={level=K,},data_escape={},data_spawn={},stage_edit=0,}end local function G(H,I)local J=H.stage_edit or 0 if J~=4 then H=nil ix.doorsSystem_editmode=nil I:Notify("Создание двери отменено!")return end local K={time_action=H.data_door_close.time_action or 1,time_sirena=H.data_door_close.time_sirena or 1,sound_door_action=H.data_door_close.sound_door_action or"",sound_door_move=H.data_door_close.sound_door_move or"",sound_door_sirena=H.data_door_close.sound_door_sirena or"",sound_keypad_access=H.data_keypad.sound_keypad_access or"",sound_keypad_denied=H.data_keypad.sound_keypad_denied or"",isRemoveCard=H.data_keypad.isRemoveCard==nil and false or H.data_keypad.isRemoveCard,keyType=H.data_keypad.keyType,}local L=m("DFrame")L:SetTitle("Завершение редактирования")L:SetSize(600,600)L:Center()L:MakePopup()local M=L:Add("EditablePanel")M:Dock(FILL)M:DockMargin(0,0,0,0)local N=M:Add("DScrollPanel")N:Dock(FILL)local O=m("DNumSlider",N)O:Dock(TOP)O:DockMargin(5,0,0,0)O:SetText("Время открытия - закрытия ( сек )")O:SetMin(1)O:SetMax(360)O:SetDecimals(0)O:SetValue(K.time_action)O.OnValueChanged=function(X,Y)Y=n(Y)K.time_action=Y end local P=m("DNumSlider",N)P:Dock(TOP)P:DockMargin(5,0,0,0)P:SetText("Время проигрывания сирены ( сек )")P:SetMin(1)P:SetMax(360)P:SetDecimals(0)P:SetValue(K.time_sirena)P.OnValueChanged=function(X,Y)Y=n(Y)K.time_sirena=Y end local Q=N:Add("DCheckBoxLabel")Q:Dock(TOP)Q:DockMargin(5,0,0,10)Q:SetText("Удалять ли ключ карту при использовании")Q:SetValue(K.isRemoveCard)Q:SizeToContents()Q.OnChange=function(X,Y)K.isRemoveCard=Y end local R=m("DTextEntry",N)R:Dock(TOP)R:DockMargin(0,0,0,5)R:SetPlaceholderText("Поиск...")local S=m("DFileBrowser",N)S:Dock(TOP)S:SetTall(200)S:SetPath("GAME")S:SetBaseFolder("sound")S:SetOpen(true)S.OnSelect=function(X,Y,Z)RunConsoleCommand("stopsound")Y=o(Y,"sound/")p(0,function()q(Y,LocalPlayer():GetPos())end)end S.OnRightClick=function(X,Y,Z)Y=o(Y,"sound/")local ab=DermaMenu()ab:AddOption("Установить как звук - Движение двери",function()K.sound_door_move=Y end)ab:AddOption("Установить как звук - Завершения движения двери",function()K.sound_door_action=Y end)ab:AddOption("Установить как звук - Сирена двери",function()K.sound_door_sirena=Y end)ab:AddOption("Установить как звук - Кепада ( успешно )",function()K.sound_keypad_access=Y end)ab:AddOption("Установить как звук - Кепада ( неудача )",function()K.sound_keypad_denied=Y end)ab:Open()end R.OnEnter=function(X)local Y=X:GetValue()S:SetSearch(Y)end for X,Y in pairs(K)do if A[X]then local Z=N:Add("EditablePanel")Z:Dock(TOP)Z:DockMargin(5,5,0,0)local ab=Z:Add("DLabel")ab:Dock(FILL)ab:SetText(A[X]..Y)ab.sound_data=Y ab:SizeToContents()ab.Think=function(cb)if cb.sound_data~=K[X]then cb:SetText(A[X]..K[X])cb:SizeToContents()end end local bb=Z:Add("ixMenuButton")bb:Dock(RIGHT)bb:SetFont("ui.Tahoma-6")bb:SetText("Прослушать")bb:SizeToContents()bb.sound_index=X bb.DoClick=function(cb)RunConsoleCommand("stopsound")p(0,function()q(K[X],LocalPlayer():GetPos())end)end end end local T=N:Add("EditablePanel")T:Dock(TOP)T:DockMargin(5,5,0,0)local U=T:Add("DLabel")U:Dock(LEFT)U:SetText("Выберите тип ключа:")U:SizeToContents()local V=vgui.Create("DComboBox",T)V:Dock(LEFT)V:DockMargin(20,0,0,0)V:SetFont("ui.Tahoma-6")V:SetValue("Выберите тип ключа доступа!")for X,Y in next,ix.doorsSystem.keyType do V:AddChoice(Y.name,X)if K.keyType and K.keyType==X then V:SetValue(Y.name)end end V:SizeToContents()V:SetWide(V:GetWide()+20)V.OnSelect=function(X,Y,Z,ab)K.keyType=ab X:SizeToContents()X:SetWide(X:GetWide()+20)end local W=M:Add("ixMenuButton")W:Dock(BOTTOM)W:SetFont("ui.Tahoma-6")W:SetText("Завершить редактирование")W:SetBackgroundColor(Color(50,100,50))W:SizeToContents()W.DoClick=function(X)H.stage_edit=nil H.data_door_close.time_action=K.time_action or 3 H.data_door_close.time_sirena=K.time_sirena or 3 H.data_door_close.sound_door_action=K.sound_door_action or nil H.data_door_close.sound_door_move=K.sound_door_move or nil H.data_door_close.sound_door_sirena=K.sound_door_sirena or nil H.data_keypad.sound_keypad_access=K.sound_keypad_access or nil H.data_keypad.sound_keypad_denied=K.sound_keypad_denied or nil H.data_keypad.isRemoveCard=K.isRemoveCard H.data_keypad.keyType=K.keyType or nil r("doors.admin-menu.edit-mode-disable")s(ix.doorsSystem_editmode.mode_type)t(ix.doorsSystem_editmode.dungeon_index,8)s(ix.doorsSystem_editmode.dungeon_name)u(H)v()ix.doorsSystem_editmode=nil L:Remove()end end ix.doorsSystem.RegisterEditModeHook(x,"PlayerBindPress",function(H,I,J,K)if((J:find("invnext")or J:find("invprev"))and K)then return true elseif(J:find("attack2")and K)then F(H,I)return true elseif(J:find("attack")and K)then E(H,I)return true elseif(J:find("reload")and K)then G(H,I)return true end end)