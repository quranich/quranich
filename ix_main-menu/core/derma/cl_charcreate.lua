-- <|> Hello, fucker | Taxin2012 and PURP was here | Mysterious Zone Project | mzrp.ru <|>
local a=ScreenScale(64)local b=ix.util.GetMaterial("pp/blurscreen")local c=ix.util.GetMaterial("purp/stalker/ui/mainmenu/background_settings.png")local d=ix.util.GetMaterial("purp/stalker/ui/mainmenu/logo_mz.png")local e=ix.util.GetMaterial("purp/stalker/ui/mainmenu/menu_line.png")local f=ix.util.GetMaterial("purp/stalker/ui/mainmenu/button_exit.png")local g=ix.util.GetMaterial("purp/stalker/ui/mainmenu/character/background.png")local h=ix.util.GetMaterial("purp/stalker/ui/mainmenu/character/background_left.png")local i=ix.util.GetMaterial("purp/stalker/ui/mainmenu/character/background_right.png")local j=ix.util.GetMaterial("purp/stalker/ui/mainmenu/arrow_left.png")local k=ix.util.GetMaterial("purp/stalker/ui/mainmenu/background_panel.png")local l={["description"]={tall=150,},["model"]={tall=135,},["characterFace"]={tall=250,}}DEFINE_BASECLASS("ixCharMenuPanel")local m={}function m:Init()local n=self:GetParent()local o=n:GetWide()*0.5-(a*2)local p=n:GetTall()*0.5-(a*2)local q=(ScrW()>ScrH()*1.8)and 100 or 78 local r,s=ScrW(),ScrH()local t,u=r/1920,s/1080 self:ResetPayload(true)self:SetPadding(0)self.factionButtons={}self.repopulatePanels={}self.factionPanel=self:AddSubpanel("faction",true)self.factionPanel:SetTitle("chooseFaction")self.factionPanel.OnSetActive=function()if(#self.factionButtons==1)then self:SetActiveSubpanel("description",0)end end local v=self.factionPanel:Add("Panel")v:Dock(RIGHT)v:SetSize(o+a*2,p)local w=self.factionPanel:Add("EditablePanel")w:SetPos(t*20,u*980)w:SetSize(t*616,u*100)local x=w:Add("ixMenuButton")x:SetText("proceed")x:SetContentAlignment(6)x:Dock(BOTTOM)x:SizeToContents()x.DoClick=function()self.progress:IncrementProgress()self:Populate()self:SetActiveSubpanel("description",0)end self.factionModel=v:Add("ixModelPanel")self.factionModel:Dock(FILL)self.factionModel:SetModel("models/error.mdl")self.factionModel:SetFOV(q)self.factionModel.PaintModel=self.factionModel.Paint self.factionButtonsPanel=self.factionPanel:Add("ixCharMenuButtonList")self.factionButtonsPanel:SetWide(o)self.factionButtonsPanel:Dock(FILL)local y=w:Add("ixMenuButton")y:SetText("return")y:SizeToContents()y:Dock(BOTTOM)y.DoClick=function()self.progress:DecrementProgress()self:SetActiveSubpanel("faction",0)self:SlideDown(0)n.mainPanel:Undim()end self.description=self:AddSubpanel("description")self.description:SetTitle("chooseDescription")self.description:SetPos(0,0)self.description:SetSize(ScrW(),ScrH())self.description.Paint=function(H,I,J)end self.description.title:Dock(NODOCK)self.description.title:SetFont("ui.Tahoma-s12")self.description.title:SetTextColor(color_white)self.description.title:SizeToContents()self.description.title:SetPos(t*328-self.description.title:GetWide()*.5,u*210)local z=self.description:Add("Panel")z:Dock(RIGHT)z:SetWide(t*1300)local A=self.description:Add("EditablePanel")A:SetPos(t*20,u*980)A:SetSize(t*616,u*100)local B=A:Add("DButton")B:SetTall(u*94)B:SetFont("ui.Tahoma-17")B:SetText(L("return"))B:SetContentAlignment(5)B:SetTextColor(Color(157,157,157))B:SizeToContents()B:SetWide(B:GetWide()+u*80)B:SetTall(B:GetTall()+u*20)B:AlignLeft(t*20)B:AlignBottom(u*20)B.hoveredTime=0 B.OnCursorEntered=function(H)B.hoveredTime=CurTime()H:SetTextColor(color_white)end B.OnCursorExited=function(H)H:SetTextColor(Color(157,157,157))end B.Paint=function(H,I,J)if H:IsHovered()then local alpha=Lerp((CurTime()-B.hoveredTime)*5,0,255)surface.SetDrawColor(Color(255,255,255,alpha))surface.SetMaterial(e)surface.DrawTexturedRect(0,0,I,J)end end B.DoClick=function(H)self.progress:DecrementProgress()if(#self.factionButtons==1)then y:DoClick()else self:SetActiveSubpanel("faction",0)end end self.descriptionModel=z:Add("ixModelPanel")self.descriptionModel:Dock(FILL)self.descriptionModel:SetModel(self.factionModel:GetModel())self.descriptionModel:SetFOV(30)self.descriptionModel.PaintModel=self.descriptionModel.Paint self.descriptionModel.PaintOver=function(H,I,J)end self.descriptionModel.LayoutEntity=function(H,I)local J=I:LookupSequence("idle_0_idle_1")if J and J~=-1 then I:SetSequence(J)H:RunAnimation()I:SetAngles(Angle(0,-20,0))end if H.isUpdateCamPos~=true then local K=self.descriptionModel.Entity if IsValid(K)then local M=ix.util.FindBoneByName(K,"bip01_head")if M~=nil then local N=K:GetBonePosition(M)N:Add(Vector(40,0,2))self.descriptionModel:SetCamPos(N-Vector(-12,0,0))self.descriptionModel:SetLookAt(N)K:SetEyeTarget(N-Vector(-12,0,0))H.isUpdateCamPos=true end end end return end self.descriptionPanel=self.description:Add("DScrollPanel")self.descriptionPanel:SetPos(t*0,u*260)self.descriptionPanel:SetSize(t*656,u*720)if IsValid(self.descriptionPanel:GetVBar())then self.descriptionPanel:GetVBar():SetWide(0)end local C=A:Add("DButton")C:SetTall(u*94)C:SetFont("ui.Tahoma-17")C:SetText(L("proceed"))C:SetContentAlignment(5)C:SetTextColor(Color(157,157,157))C:SizeToContents()C:SetWide(C:GetWide()+u*80)C:SetTall(C:GetTall()+u*20)C:AlignRight(t*20)C:AlignBottom(u*20)C:SetZPos(999)C.hoveredTime=0 C.OnCursorEntered=function(H)C.hoveredTime=CurTime()H:SetTextColor(color_white)end C.OnCursorExited=function(H)H:SetTextColor(Color(157,157,157))end C.Paint=function(H,I,J)if H:IsHovered()then local alpha=Lerp((CurTime()-C.hoveredTime)*5,0,255)surface.SetDrawColor(Color(255,255,255,alpha))surface.SetMaterial(e)surface.DrawTexturedRect(0,0,I,J)end end C.DoClick=function(H)if(self:VerifyProgression("description"))then print(#self.attributesPanel:GetChildren())if(#self.attributesPanel:GetChildren()<=2)then self:SendPayload()return end self.progress:IncrementProgress()self:SetActiveSubpanel("attributes",0)end end self.attributes=self:AddSubpanel("attributes")self.attributes:SetTitle("chooseSkills")self.attributes:SetPos(0,0)self.attributes:SetSize(ScrW(),ScrH())self.attributes.title:Dock(NODOCK)self.attributes.title:SetFont("ui.Tahoma-s12")self.attributes.title:SetTextColor(color_white)self.attributes.title:SizeToContents()self.attributes.title:SetPos(t*328-self.attributes.title:GetWide()*.5,u*210)local D=self.attributes:Add("Panel")D:Dock(RIGHT)D:SetWide(t*1300)local E=self.attributes:Add("EditablePanel")E:SetPos(t*20,u*980)E:SetSize(t*616,u*100)local F=E:Add("DButton")F:SetTall(u*94)F:SetFont("ui.Tahoma-17")F:SetText(L("return"))F:SetContentAlignment(5)F:SetTextColor(Color(157,157,157))F:SizeToContents()F:SetWide(F:GetWide()+u*80)F:SetTall(F:GetTall()+u*20)F:AlignLeft(t*20)F:AlignBottom(u*20)F.hoveredTime=0 F.OnCursorEntered=function(H)F.hoveredTime=CurTime()H:SetTextColor(color_white)end F.OnCursorExited=function(H)H:SetTextColor(Color(157,157,157))end F.Paint=function(H,I,J)if H:IsHovered()then local alpha=Lerp((CurTime()-F.hoveredTime)*5,0,255)surface.SetDrawColor(Color(255,255,255,alpha))surface.SetMaterial(e)surface.DrawTexturedRect(0,0,I,J)end end F.DoClick=function(H)self.progress:DecrementProgress()self:SetActiveSubpanel("description",0)end self.attributesModel=D:Add("ixModelPanel")self.attributesModel:Dock(FILL)self.attributesModel:SetModel(self.factionModel:GetModel())self.attributesModel:SetFOV(30)self.attributesModel.PaintModel=self.attributesModel.Paint self.attributesModel.PaintOver=function(H,I,J)end self.attributesModel.LayoutEntity=function(H,I)local J=I:LookupSequence("idle_0_idle_1")if J and J~=-1 then I:SetSequence(J)H:RunAnimation()I:SetAngles(Angle(0,-20,0))end if H.isUpdateCamPos~=true then local K=self.attributesModel.Entity if IsValid(K)then local M=ix.util.FindBoneByName(K,"bip01_head")if M~=nil then local N=K:GetBonePosition(M)N:Add(Vector(40,0,2))self.attributesModel:SetCamPos(N-Vector(-12,0,0))self.attributesModel:SetLookAt(N)K:SetEyeTarget(N-Vector(-12,0,0))H.isUpdateCamPos=true end end end return end self.attributesPanel=self.attributes:Add("DScrollPanel")self.attributesPanel:SetPos(t*0,u*260)self.attributesPanel:SetSize(t*616,u*600)self.attributesPanel.Paint=function(H,I,J)end local G=E:Add("DButton")G:SetTall(u*94)G:SetFont("ui.Tahoma-17")G:SetText(L("proceed"))G:SetContentAlignment(5)G:SetTextColor(Color(157,157,157))G:SizeToContents()G:SetWide(G:GetWide()+u*80)G:SetTall(G:GetTall()+u*20)G:AlignRight(t*20)G:AlignBottom(u*20)G:SetZPos(999)G.hoveredTime=0 G.OnCursorEntered=function(H)G.hoveredTime=CurTime()H:SetTextColor(color_white)end G.OnCursorExited=function(H)H:SetTextColor(Color(157,157,157))end G.Paint=function(H,I,J)if H:IsHovered()then local alpha=Lerp((CurTime()-G.hoveredTime)*5,0,255)surface.SetDrawColor(Color(255,255,255,alpha))surface.SetMaterial(e)surface.DrawTexturedRect(0,0,I,J)end end G.DoClick=function(H)self:SendPayload()end self.progress=self:Add("ixSegmentedProgress")self.progress:SetBarColor(ix.config.Get("color"))self.progress:SetSize(0,0)self.progress:SizeToContents()self.progress:SetPos(0,n:GetTall()-self.progress:GetTall())self:AddPayloadHook("model",function(H)local I=ix.faction.indices[self.payload.faction]if(I)then local J=I:GetModels(LocalPlayer())[H]if(istable(J))then local K=(self.payload["characterFace"]or"0")self.factionModel:SetModel(J[1],J[2]or 0,"000"..K)self.descriptionModel:SetModel(J[1],J[2]or 0,"000"..K)self.attributesModel:SetModel(J[1],J[2]or 0,"000"..K)else self.factionModel:SetModel(J)self.descriptionModel:SetModel(J)self.attributesModel:SetModel(J)end end end)self:AddPayloadHook("characterFace",function(H)self.factionModel:SetModel(self.factionModel:GetModel(),self.factionModel.Entity:GetSkin(),"000"..H)self.descriptionModel:SetModel(self.descriptionModel:GetModel(),self.descriptionModel.Entity:GetSkin(),"000"..H)self.attributesModel:SetModel(self.attributesModel:GetModel(),self.attributesModel.Entity:GetSkin(),"000"..H)end)net.Receive("ixCharacterAuthed",function()timer.Remove("ixCharacterCreateTimeout")self.awaitingResponse=false local H=net.ReadUInt(32)local I=net.ReadUInt(6)local J={}for K=1,I do J[#J+1]=net.ReadUInt(32)end ix.characters=J self:SlideDown(0)if(!IsValid(self)or!IsValid(n))then return end if(LocalPlayer():GetCharacter())then n.mainPanel:Undim()n:ShowNotice(2,L("charCreated"))elseif(H)then self.bMenuShouldClose=true net.Start("ixCharacterChoose")net.WriteUInt(H,32)net.SendToServer()else self:SlideDown(0)end end)net.Receive("ixCharacterAuthFailed",function()timer.Remove("ixCharacterCreateTimeout")self.awaitingResponse=false local H=net.ReadString()local I=net.ReadTable()self:SlideDown(0)n.mainPanel:Undim()n:ShowNotice(3,L(H,unpack(I)))end)end function m:SendPayload()if(self.awaitingResponse or!self:VerifyProgression())then return end self.awaitingResponse=true timer.Create("ixCharacterCreateTimeout",10,1,function()if(IsValid(self)and self.awaitingResponse)then local n=self:GetParent()self.awaitingResponse=false self:SlideDown(0)n.mainPanel:Undim()n:ShowNotice(3,L("unknownError"))end end)self.payload:Prepare()net.Start("ixCharacterCreate")net.WriteUInt(table.Count(self.payload),8)for n,o in pairs(self.payload)do net.WriteString(n)net.WriteType(o)end net.SendToServer()end function m:OnSlideUp()self:ResetPayload()self:Populate()self.progress:SetProgress(1)self:SetActiveSubpanel("faction",0)end function m:OnSlideDown()end function m:ResetPayload(n)if(n)then self.hooks={}end self.payload={}function self.payload.Set(o,p,q)self:SetPayload(p,q)end function self.payload.AddHook(o,p,q)self:AddPayloadHook(p,q)end function self.payload.Prepare(o)self.payload.Set=nil self.payload.AddHook=nil self.payload.Prepare=nil end end function m:SetPayload(n,o)self.payload[n]=o self:RunPayloadHook(n,o)end function m:AddPayloadHook(n,o)if(!self.hooks[n])then self.hooks[n]={}end self.hooks[n][#self.hooks[n]+1]=o end function m:RunPayloadHook(n,o)local p=self.hooks[n]or{}for q,r in ipairs(p)do r(o)end end function m:GetContainerPanel(n)if(n=="description")then return self.descriptionPanel elseif(n=="attributes")then return self.attributesPanel end return self.descriptionPanel end function m:AttachCleanup(n)self.repopulatePanels[#self.repopulatePanels+1]=n end function m:Populate()if(!self.bInitialPopulate)then local s for t,u in pairs(self.factionButtons)do if(u:GetSelected())then s=u.faction end if(IsValid(u))then u:Remove()end end self.factionButtons={}for t,u in SortedPairs(ix.faction.teams)do if(ix.faction.HasWhitelist(u.index))then local v=self.factionButtonsPanel:Add("ixMenuSelectionButton")v:SetBackgroundColor(u.color or color_white)v:SetText(L(u.name):utf8upper())v:SizeToContents()v:SetButtonList(self.factionButtons)v.faction=u.index v.OnSelected=function(w)local x=ix.faction.indices[w.faction]local y=x:GetModels(LocalPlayer())self.payload:Set("faction",w.faction)self.payload:Set("model",math.random(1,#y))end if((s and s==u.index)or(!s and u.isDefault))then v:SetSelected(true)s=u.index end end end end for s=1,#self.repopulatePanels do self.repopulatePanels[s]:Remove()end self.repopulatePanels={}if(!self.payload.faction)then for s,t in pairs(self.factionButtons)do if(t:GetSelected())then t:SetSelected(true)break end end end self.factionButtonsPanel:SizeToContents()local n=1 local o,p=ScrW(),ScrH()local q,r=o/1920,p/1080 if IsValid(self.descriptionPanel)then self.descriptionPanel:Clear()end ix.char.vars["model"].index=2 ix.char.vars["description"].index=3 for s,t in SortedPairsByMemberValue(ix.char.vars,"index")do if(!t.bNoDisplay and s!="__SortedIndex")then local u=self:GetContainerPanel(t.category or"description")if(t.ShouldDisplay and t:ShouldDisplay(u,self.payload)==false)then continue end local v,w if t.field=="attributes"then if(t.OnDisplay)then w=t:OnDisplay(u,self.payload)w:DockMargin(q*10,0,q*10,0)end if IsValid(w)then w:SetZPos(n)self:AttachCleanup(w)if(t.OnPostSetup)then t:OnPostSetup(w,self.payload)end n=n+2 end else local x=vgui.Create("DCollapsibleCategory",u)x:SetLabel(L(s):utf8upper())x:Dock(TOP)x:SetExpanded(false)x:SetHeaderHeight(r*60)x.Header:SetFont("ui.Tahoma-s12")x.Header:SetContentAlignment(5)x.Paint=function(A,B,C)B,C=A.Header:GetSize()if A:GetExpanded()==true then local alpha=Lerp((CurTime()-(A.hoveredTime or 0))*5,0,255)surface.SetDrawColor(Color(255,255,255,alpha))surface.SetMaterial(e)surface.DrawTexturedRect(q*10,0,B-q*20,C)end end x.OnToggle=function(A,B)if B==true then for C,D in next,u:GetCanvas():GetChildren()do if D==A then continue end if D:GetExpanded()==true then D:Toggle()end end end end local y=vgui.Create("DScrollPanel")y:GetVBar():SetWide(0)y:GetCanvas():DockPadding(0,r*10,0,r*10)x:SetContents(y)local z=y:Add("EditablePanel")z:Dock(FILL)z.Paint=function(A,B,C)surface.SetDrawColor(Color(255,255,255,alpha))surface.SetMaterial(k)surface.DrawTexturedRect(0,0,B,C)end if(t.OnDisplay)then w=t:OnDisplay(z,self.payload)w:DockMargin(q*60,q*30,r*70,q*25)elseif(isstring(t.default))then w=z:Add("ixTextEntry")w:Dock(FILL)w:DockMargin(q*70,q*30,r*80,q*25)w:SetFont("ixMenuButtonFont")w:SetUpdateOnType(true)w:SizeToContents()w:SetTall(draw.GetFontHeight(w:GetFont())+r*10)w.OnValueChange=function(A,B)self.payload:Set(s,B)end end print("k",s)if(IsValid(w))then local A=(l[s]and(l[s].tall or 0)or 0)local B,C,D,E=w:GetDockPadding()z:SetTall(w:GetTall()+r*55+r*A)z:SetZPos(n-1)w:SetZPos(n)self:AttachCleanup(z)self:AttachCleanup(w)if(t.OnPostSetup)then t:OnPostSetup(w,self.payload)w:SetBackgroundColor(color_black)end n=n+2 end end end end if(!self.bInitialPopulate)then if(#self.factionButtons>1)then self.progress:AddSegment("@faction")end self.progress:AddSegment("@description")if(#self.attributesPanel:GetChildren()>1)then self.progress:AddSegment("@skills")end if(#self.progress:GetSegments()==1)then self.progress:SetVisible(false)end end self.bInitialPopulate=true end function m:VerifyProgression(n)for o,p in SortedPairsByMemberValue(ix.char.vars,"index")do if(n~=nil and(p.category or"description")!=n)then continue end local q=self.payload[o]if(!p.bNoDisplay or p.OnValidate)then if(p.OnValidate)then local r={p:OnValidate(q,self.payload,LocalPlayer())}if(r[1]==false)then self:GetParent():ShowNotice(3,L(unpack(r,2)))return false end end self.payload[o]=q end end return true end function m:Paint(n,o)surface.SetMaterial(b)surface.SetDrawColor(255,255,255,alpha or 255)local p,q=self:LocalToScreen(0,0)for r=-(passes or 0.2),1,0.2 do b:SetFloat("$blur",r*5)b:Recompute()render.UpdateScreenEffectTexture()surface.DrawTexturedRect(p*-1,q*-1,n,o)end draw.RoundedBox(0,0,0,n,o,Color(40,40,40,gui.IsGameUIVisible()and 255 or 200))surface.SetDrawColor(color_white)surface.SetMaterial(g)surface.DrawTexturedRect(0,0,n,o)BaseClass.Paint(self,n,o)end vgui.Register("ixCharMenuNew",m,"ixCharMenuPanel")