-- <|> Hello, fucker | Taxin2012 and PURP was here | Mysterious Zone Project | mzrp.ru <|>
local a=net.Start local b=net.WriteUInt local c=net.SendToServer local d=string.format local AccessorFunc=AccessorFunc local ClientsideModel=ClientsideModel local Vector=Vector local Angle=Angle local RealTime=RealTime local e=cam.Start3D local f=render.SuppressEngineLighting local g=render.SetLightingOrigin local h=render.SetModelLighting local math=math local i=render.SetStencilEnable local j=render.SetStencilWriteMask local k=render.SetStencilTestMask local l=render.SetStencilReferenceValue local m=render.SetStencilCompareFunction local n=render.SetStencilPassOperation local o=render.SetStencilFailOperation local p=render.SetStencilZFailOperation local q=render.SetScissorRect local r=cam.Start2D local derma=derma local s=cam.End2D local t=cam.End3D local u=vgui.Register local v=net.Start local w=net.WriteUInt local x=net.SendToServer local y=surface.GetTextureID local Color=Color local ScreenScale=ScreenScale local z=surface.SetMaterial local A=surface.SetDrawColor local surface=surface local ScrW=ScrW local ScrH=ScrH local draw=draw local B=draw.RoundedBox local C=surface.DrawRect local LocalPlayer=LocalPlayer local istable=istable local D=net.Receive local E=timer.Remove local F=net.ReadUInt local IsValid=IsValid local G=net.Start local H=net.WriteUInt local I=net.SendToServer local J=net.ReadString local K=net.ReadTable local unpack=unpack local M=timer.Create local N=table.Count local pairs=pairs local O=net.WriteString local P=net.WriteType local ipairs=ipairs local SortedPairs=SortedPairs local Q=math.random local SortedPairsByMemberValue=SortedPairsByMemberValue local isstring=isstring local R=surface.SetTexture local S=surface.DrawTexturedRect local BaseClass=BaseClass local T=vgui.Register local U=ix.plugin.list["main-menu"]local V=y("vgui/gradient-d")local W=ix.util.GetMaterial("purp/stalker/ui/ui_actor_multiplayer_background.png")local X=ix.util.GetMaterial("purp/stalker/ui/ui_actor_widescreen_sidepanels.png")local Y=ix.util.GetMaterial("purp/stalker/ui/ui_actor_widescreen_sidepanels_1.png")local Z=ix.util.GetMaterial("purp/stalker/ui/ui_actor_menu.png")local ab=ix.util.GetMaterial('purp/stalker/ui/ui_actor_hint_wnd.png')local bb=ix.util.GetMaterial('purp/stalker/ui/ui_actor_multiplayer_game_menu.png')local cb=ix.util.GetMaterial("pp/blurscreen")local db=ix.util.GetMaterial('purp/stalker/ui/mainmenu/character/background_select.png')local eb=ix.util.GetMaterial('purp/stalker/ui/mainmenu/character/background_select_menu.png')local fb=ix.util.GetMaterial("purp/stalker/ui/mainmenu/menu_line.png")local gb=ix.util.GetMaterial("purp/stalker/ui/mainmenu/bg_avatar_active.png")local hb=ix.util.GetMaterial("purp/stalker/ui/mainmenu/bg_avatar_noactive.png")local ib=Color(230,220,190)local function jb(pb,qb,rb)z(Y)A(color_white)surface.DrawPartialTexturedRect(0,0,qb,rb,290,435,624,411,1024,1024)end local function kb(pb,qb,rb)local sb=pb:IsHovered()z(Z)A(color_white)surface.DrawPartialTexturedRect(0,0,qb,rb,341,sb and 850 or 874,133,24,1024,1024)end local lb="models/error.mdl"local mb={}AccessorFunc(mb,"animationTime","AnimationTime",FORCE_NUMBER)local function nb(self,pb)self.character=pb if(pb)then self:SetModel(pb:GetModel())self:SetSkin(pb:GetData("skin",0))for rb=0,(self:GetNumBodyGroups()-1)do self:SetBodygroup(rb,0)end local qb=pb:GetData("groups",nil)if(istable(qb))then for rb,sb in pairs(qb)do self:SetBodygroup(rb,sb)end end else self:SetModel(lb)end end local function ob(self)return self.character end function mb:Init()self.activeCharacter=ClientsideModel(lb)self.activeCharacter:SetNoDraw(true)self.activeCharacter.SetCharacter=nb self.activeCharacter.GetCharacter=ob self.lastCharacter=ClientsideModel(lb)self.lastCharacter:SetNoDraw(true)self.lastCharacter.SetCharacter=nb self.lastCharacter.GetCharacter=ob self.animationTime=0.5 self.shadeY=0 self.shadeHeight=0 self.cameraPosition=Vector(80,0,35)self.cameraAngle=Angle(0,180,0)self.lastPaint=0 end function mb:ResetSequence(pb,qb)local rb=pb:LookupSequence("animpoint_sit_low_idle_1")if(rb<=0)then rb=pb:SelectWeightedSequence(ACT_IDLE)end if(rb>0)then pb:ResetSequence(rb)else local sb=false local tb=pb and pb:GetSequenceList()or{}for ub,vb in ipairs(tb or{})do if((vb:lower():find("low visual")or vb:lower():find("fly"))and vb!="idlenoise")then pb:ResetSequence(vb)sb=true break end end if(!sb)then pb:ResetSequence(4)end end pb:SetIK(false)if(qb)then pb:SetCycle(qb:GetCycle())end end function mb:RunAnimation(pb)pb:FrameAdvance((RealTime()-self.lastPaint)*0.5)end function mb:LayoutEntity(pb)pb:SetIK(false)self:RunAnimation(pb)end function mb:SetActiveCharacter(pb)self.shadeY=self:GetTall()self.shadeHeight=self:GetTall()if(self.activeCharacter:GetModel()==lb)then self.activeCharacter:SetCharacter(pb)self:ResetSequence(self.activeCharacter)return end local qb=self:GetTweenAnimation(1)local rb=self:GetTweenAnimation(2)if(qb)then qb.newCharacter=pb return elseif(rb)then rb.queuedCharacter=pb return end self.lastCharacter:SetCharacter(self.activeCharacter:GetCharacter())self:ResetSequence(self.lastCharacter,self.activeCharacter)qb=self:CreateAnimation(self.animationTime*0.5,{index=1,target={shadeY=0,shadeHeight=self:GetTall()},easing="linear",OnComplete=function(sb,tb)tb.activeCharacter:SetCharacter(sb.newCharacter)tb:ResetSequence(tb.activeCharacter)tb:CreateAnimation(tb.animationTime,{index=2,target={shadeHeight=0},easing="outQuint",OnComplete=function(ub,vb)if(ub.queuedCharacter)then vb:SetActiveCharacter(ub.queuedCharacter)else vb.lastCharacter:SetCharacter(nil)end end})end})qb.newCharacter=pb end function mb:Paint(pb,qb)local rb,sb=self:LocalToScreen(0,0)local tb=self.lastCharacter:GetModel()!=lb local ub=self.modelFov or((ScrW()>ScrH()*1.8)and 92 or 70)e(self.cameraPosition,self.cameraAngle,ub*0.85,rb,sb,pb,qb)f(true)g(self.activeCharacter:GetPos())h(0,1.5,1.5,1.5)for Bb=1,4 do h(Bb,0.4,0.4,0.4)end h(5,0.04,0.04,0.04)local vb=self local wb=self:GetWide()local xb=0 local yb=0 local zb=self:GetTall()local Ab=vb while(vb:GetParent()!=nil)do local Bb,Cb=Ab:GetPos()vb=vb:GetParent()yb=math.Max(Cb,yb+Cb)xb=math.Max(Bb,xb+Bb)zb=math.Min(Cb+Ab:GetTall(),zb+Cb)wb=math.Min(Bb+Ab:GetWide(),wb+Bb)Ab=vb end ix.util.ResetStencilValues()i(true)j(30)k(30)l(31)m(STENCIL_ALWAYS)n(STENCIL_REPLACE)o(STENCIL_KEEP)p(STENCIL_KEEP)self:LayoutEntity(self.activeCharacter)if(tb)then self:LayoutEntity(self.lastCharacter)q(xb,yb,wb,zb-(self:GetTall()-self.shadeHeight),true)self.lastCharacter:DrawModel()q(xb,yb+self.shadeHeight,wb,zb,true)self.activeCharacter:DrawModel()q(xb,yb,wb,zb,true)else self.activeCharacter:DrawModel()end m(STENCIL_EQUAL)n(STENCIL_KEEP)r()derma.SkinFunc("PaintCharacterTransitionOverlay",self,0,self.shadeY,pb,self.shadeHeight)s()i(false)q(0,0,0,0,false)f(false)t()self.lastPaint=RealTime()end function mb:OnRemove()self.lastCharacter:Remove()self.activeCharacter:Remove()end T("ixCharMenuCarousel",mb,"Panel")mb={}AccessorFunc(mb,"animationTime","AnimationTime",FORCE_NUMBER)AccessorFunc(mb,"backgroundFraction","BackgroundFraction",FORCE_NUMBER)function mb:Init()local pb=self:GetParent()local qb=self:GetPadding()local rb=(ScrW()>ScrH()*1.8)and 102 or 78 local sb,tb,ub,vb=ScrW(),ScrH(),1024,768 local wb=surface.IsWideScreen(sb,tb)ub=wb and 1280 or ub local xb,yb=sb/ub,tb/vb local zb=wb and(128*xb)or 0 local Ab=wb and 128 or 64 local Bb=xb*Ab local Cb=(yb*411)*1.6 local Db,Eb=ScrW(),ScrH()local Fb,Gb=Db/1920,Eb/1080 self.animationTime=1 self.backgroundFraction=1 self:SetPadding(0)ix.gui.charloadFrame=self self.panel=self:AddSubpanel("main")self.panel:SetTitle("")self.panel:SetTall(Eb)self.panel:Center()local Hb,Ib=Fb,Gb self.panel.OnSetActive=function()self:CreateAnimation(self.animationTime,{index=2,target={backgroundFraction=1},easing="outQuint",})end self.panel.title:Dock(NODOCK)self.panel.title:SetFont("ui.Tahoma-s12")self.panel.title:SetTextColor(color_white)self.panel.title:SizeToContents()self.panel.title:SetPos(Fb*1-self.panel.title:GetWide()*.5,Gb*1)self.characterList=self.panel:Add("ixCharMenuButtonList")self.characterList.buttons={}self.characterList:SetPos(Fb*20,Gb*260)self.characterList:SetSize(Fb*616,Gb*720)self.characterList.SizeToContents=function(Nb)local Ob=Nb:GetCanvas()Ob:InvalidateLayout(true)Ob:Dock(NODOCK)end self.characterList.Paint=function(Nb,Ob,Pb)end local Jb=self.characterList:GetVBar()Jb:SetWide(Hb*7)Jb:SetVisible(true)Jb.Paint=function(Nb,Ob,Pb)draw.OutlinedBox(0,0,Ob,Pb,Color(57,61,63),Color(82,85,90),1)end Jb.btnUp.Paint=function(Nb,Ob,Pb)B(0,3,3,Ob-6,Pb-6,Color(87,86,87))end Jb.btnGrip.Paint=function(Nb,Ob,Pb)B(0,3,3,Ob-6,Pb-6,Color(87,86,87))end Jb.btnDown.Paint=function(Nb,Ob,Pb)B(0,3,3,Ob-6,Pb-6,Color(87,86,87))end self.carousel=self.panel:Add("DModelPanel")self.carousel:SetPos(Fb*920,Gb*195)self.carousel:SetSize(Fb*632,Gb*816)self.carousel:SetModel("models/topor/mz/new_stalker_0.mdl")self.carousel:SetFOV(30)local Kb=U:GetMapBackground()if Kb then for Nb,Ob in next,(Kb[3]or{})do self.carousel:SetDirectionalLight(Nb,Ob)end end self.carousel.SetActiveCharacter=function(Nb,Ob)local Pb=Ob.GetCharacterFace and Ob:GetCharacterFace()or 0 local Qb=Ob:GetModel()self.carousel:SetModel(Qb)local Rb=Ob:GetData("groups",{})Rb[3]=Pb if self.carousel and IsValid(self.carousel.Entity)then for Sb,Tb in next,Rb do self.carousel.Entity:SetBodygroup(Sb,Tb)end end end self.carousel.LayoutEntity=function(Nb,Ob)local Pb=Ob:LookupSequence("animpoint_sit_low_idle_1")if Pb and Pb~=-1 then Ob:SetSequence(Pb)Nb:RunAnimation()Ob:SetAngles(Angle(5,30,0))end if Nb.isUpdateCamPos~=true then local Qb=Nb.Entity if IsValid(Qb)then local Rb=ix.util.FindBoneByName(Qb,"bip01_head")if Rb~=nil then local Sb=Qb:GetBonePosition(Rb)Sb:Add(Vector(110,5,-14))Nb:SetCamPos(Sb-Vector(-12,0,0))Nb:SetLookAt(Sb)Qb:SetEyeTarget(Sb-Vector(-12,0,0))Nb.isUpdateCamPos=true end end end return end local Lb=self.panel:Add("EditablePanel")Lb:SetPos(Fb*20,Gb*980)Lb:SetSize(Fb*616,Gb*100)local Mb=Lb:Add("DButton")Mb:SetTall(Gb*94)Mb:SetFont("ui.Tahoma-17")Mb:SetText(L("return"))Mb:SetContentAlignment(5)Mb:SetTextColor(Color(157,157,157))Mb:SizeToContents()Mb:SetWide(Mb:GetWide()+Gb*80)Mb:SetTall(Mb:GetTall()+Gb*20)Mb:AlignLeft(Fb*20)Mb.hoveredTime=0 Mb.OnCursorEntered=function(Nb)Mb.hoveredTime=CurTime()Nb:SetTextColor(color_white)end Mb.OnCursorExited=function(Nb)Nb:SetTextColor(Color(157,157,157))end Mb.Paint=function(Nb,Ob,Pb)if Nb:IsHovered()then local Qb=Lerp((CurTime()-Mb.hoveredTime)*5,0,255)surface.SetDrawColor(Color(255,255,255,Qb))surface.SetMaterial(fb)surface.DrawTexturedRect(0,0,Ob,Pb)end end Mb.DoClick=function(Nb)self:SlideDown(0)pb.mainPanel:Undim()end self.continueButton=Lb:Add("DButton")self.continueButton:SetTall(Gb*94)self.continueButton:SetFont("ui.Tahoma-17")self.continueButton:SetText(L("choose"))self.continueButton:SetContentAlignment(5)self.continueButton:SetTextColor(Color(157,157,157))self.continueButton:SizeToContents()self.continueButton:SetWide(self.continueButton:GetWide()+Gb*80)self.continueButton:SetTall(self.continueButton:GetTall()+Gb*20)self.continueButton:AlignRight(Fb*20)self.continueButton.hoveredTime=0 self.continueButton.OnCursorEntered=function(Nb)self.continueButton.hoveredTime=CurTime()Nb:SetTextColor(color_white)end self.continueButton.OnCursorExited=function(Nb)Nb:SetTextColor(Color(157,157,157))end self.continueButton.Paint=function(Nb,Ob,Pb)if Nb:IsHovered()then local Qb=Lerp((CurTime()-self.continueButton.hoveredTime)*5,0,255)surface.SetDrawColor(Color(255,255,255,Qb))surface.SetMaterial(fb)surface.DrawTexturedRect(0,0,Ob,Pb)end end self.continueButton.DoClick=function(Nb)local Ob=self.character:GetID()local Pb=ix.char.loaded[Ob]local Qb=string.Split(game.GetIPAddress(),":")[2]local Rb=Pb:GetData("Twin",game.GetIPAddress())local Sb=ix.plugin.list["twin"].whiteList local Tb=string.Split(Rb,":")[2]local Ub=Pb:GetData("OldTwin")if Ub==nil or Ub[1]~=Qb then local Vb=Pb:GetData("Twin",Qb)local Wb=(string.len(tostring(Vb))>5 and string.Split(Vb,":")[2])or Vb Vb=(Wb~=nil and Wb)or Qb if Vb~=Qb and Pb:HasFlags("w")==false then stalker_Derma_Query(self,"Выбранный персонаж находится на другой локации вам необходимо подключиться к другому серверу","Подключиться",function()local Xb=string.format("connect 185.207.214.6:%s",Vb)LocalPlayer():ConCommand(Xb)end,"Отмена",function()end)return end end G("ixCharacterChoose")H(self.character:GetID(),32)I()end self:SetActiveSubpanel("main",0)end function mb:OnCharacterDeleted(pb)if(self.bActive and#ix.characters==0)then self:SlideDown(0)end end function mb:Populate(pb)local qb,rb=ScrW(),ScrH()local sb,tb=qb/1920,rb/1080 self.characterList:Clear()self.characterList.buttons={}local ub for vb=1,#ix.characters do local wb=ix.characters[vb]local xb=ix.char.loaded[wb]if(!xb or xb:GetID()==pb)then continue end local yb=xb:GetFaction()local zb=ix.faction.indices[yb]local Ab=zb and zb.color or color_white local Bb=xb:GetName()local Cb=xb:GetFaction()local Db=self.characterList:Add("ixMenuSelectionButton")Db:Dock(TOP)Db:DockMargin(sb*125,0,sb*125,tb*50)Db:SetText("")Db:SetButtonList(self.characterList.buttons)Db:SetTall(tb*256)Db.character=xb Db.Paint=function(Jb,Kb,Lb)if self.character:GetID()==wb then draw.RoundedBox(Lb*.15,0,0,Kb,Lb,Color(255,255,255,25))end end Db.OnSelected=function(Jb)self:OnCharacterButtonSelected(Jb)end local Eb=Db:Add("DLabel")Eb:Dock(TOP)Eb:DockMargin(0,0,0,tb*10)Eb:SetFont("ui.Tahoma-s8")Eb:SetText(Bb)Eb:SizeToContents()Eb:SetContentAlignment(5)local Fb=Db:Add("DLabel")Fb:Dock(BOTTOM)Fb:DockMargin(0,0,0,tb*10)Fb:SetFont("ui.Tahoma-s8")Fb:SetText(ix.faction.indices[Cb]and ix.faction.indices[Cb].name or"FNAME")Fb:SizeToContents()Fb:SetContentAlignment(5)local Gb=Db:Add("EditablePanel")Gb:Dock(FILL)Gb:SetMouseInputEnabled(false)Gb.Paint=function(Jb,Kb,Lb)local Mb=Db:IsHovered()surface.SetDrawColor(color_white)surface.SetMaterial(Mb and gb or hb)surface.DrawTexturedRect(0,0,Kb,Lb)end local Hb=Gb:Add("DModelPanel")Hb:Dock(FILL)Hb:DockMargin(sb*20,tb*30,sb*30,tb*15)Hb:SetModel(xb:GetModel())Hb:SetFOV(30)Hb:SetMouseInputEnabled(false)Hb.DoClick=function(Jb)print("DO CLICK")end Hb.LayoutEntity=function(Jb,Kb)local Lb=Kb:LookupSequence("idle_0_idle_1")if Lb and Lb~=-1 then Kb:SetSequence(Lb)Jb:RunAnimation()Kb:SetAngles(Angle(0,-20,0))end if Jb.isUpdateCamPos~=true then if IsValid(Kb)then local Mb=ix.util.FindBoneByName(Kb,"bip01_head")if Mb~=nil then local Nb=Kb:GetBonePosition(Mb)Nb:Add(Vector(40,0,2))Jb:SetCamPos(Nb-Vector(-12,0,0))Jb:SetLookAt(Nb)Kb:SetEyeTarget(Nb-Vector(-12,0,0))local Ob=xb.GetCharacterFace and xb:GetCharacterFace()or 0 Kb:SetBodygroup(3,Ob)Jb.isUpdateCamPos=true end end end return end Db:InvalidateParent(true)local Ib=LocalPlayer().GetCharacter and LocalPlayer():GetCharacter()if(Ib and xb:GetID()==Ib:GetID())then Db:SetSelected(true)self.characterList:ScrollToChild(Db)ub=true end end if(!ub)then local vb=self.characterList.buttons if(#vb>0)then local wb=vb[#vb]wb:SetSelected(true)self.characterList:ScrollToChild(wb)else self.character=nil end end self.characterList:SizeToContents()end function mb:OnSlideUp()self.bActive=true self:Populate()end function mb:OnSlideDown()self.bActive=false end function mb:OnCharacterButtonSelected(pb)self.carousel:SetActiveCharacter(pb.character)self.character=pb.character end function mb:Paint(pb,qb)local rb,sb=ScrW(),ScrH()local tb,ub=rb/1920,sb/1080 local vb=U:GetMapBackground()if vb then vb[1]:SetInt("$flags",bit.bor(vb[1]:GetInt("$flags"),32768))surface.SetDrawColor(color_white)surface.SetMaterial(vb[1])surface.DrawTexturedRect(tb*vb[4].x,ub*vb[4].y,tb*vb[4].w,ub*vb[4].h)surface.SetDrawColor(color_white)surface.SetMaterial(vb[2])surface.DrawTexturedRect(0,0,pb,qb)end surface.SetDrawColor(color_white)surface.SetMaterial(eb)surface.DrawTexturedRect(0,0,pb,qb)end T("ixCharMenuLoad",mb,"ixCharMenuPanel")if IsValid(ix.gui.charloadFrame)then local pb,qb=ScrW(),ScrH()local rb,sb=pb/1920,qb/1080 local self=ix.gui.charloadFrame self.carousel:SetPos(rb*920,sb*175)self.carousel:SetSize(rb*632,sb*816)local tb=U:GetMapBackground()for ub,vb in next,(tb[3]or{})do self.carousel:SetDirectionalLight(ub,vb)end self.carousel.PaintOver=function(ub,vb,wb)end end