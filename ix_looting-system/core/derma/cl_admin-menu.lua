-- <|> Hello, fucker | Taxin2012 and PURP was here | Mysterious Zone Project | mzrp.ru <|>
local a=string.find local LocalPlayer=LocalPlayer local CAMI=CAMI local IsValid=IsValid local ScrW=ScrW local ScrH=ScrH local b=draw.DrawText local c=timer.Simple local d=net.Start local e=net.SendToServer local f=draw.RoundedBox local Color=Color local DermaMenu=DermaMenu local g=net.WriteUInt local Derma_StringRequest=Derma_StringRequest local print=print local h=net.WriteTable local PrintTable=PrintTable local i=table.RemoveByValue local j=string.PatternSafe local tostring=tostring local k=table.insert local l=table.remove local Derma_Query=Derma_Query local tonumber=tonumber local Derma_Message=Derma_Message local m=math.Clamp local n=vgui.Register local o=ix.plugin.list["looting-system"]local function p(r,s)if not a("1234567890",s,1,true)then return true end return false end local q={}function q:Init()local r=LocalPlayer()if not CAMI.PlayerHasAccess(r,"Helix - Looting Menu",nil)then self:Remove()return r:Notify("У вас недостаточно прав.")end if IsValid(ix.gui.lootingAdminMenu)then ix.gui.lootingAdminMenu:Remove()end self:SetTitle("Looting System v2 - Админ меню")self:SetSize(ScrW()*.45,ScrH()*.75)self:Center()self:MakePopup()self:SetSkin("Default")self.panelBase=self:Add("EditablePanel")self.panelBase:Dock(FILL)self.panelBase:InvalidateParent(true)ix.gui.lootingAdminMenu=self end function q:InitLoading(r)self.panelBase:Clear()local s=self.panelBase:Add("EditablePanel")s:Dock(FILL)s.Paint=function(t,u,v)b(r or"Пожалуйста подождите.","ui.Tahoma-9",u*.5,v*.5,color_white,TEXT_ALIGN_CENTER)end c(5,function()if IsValid(self)and IsValid(s)then self:InitData()return LocalPlayer():Notify("Ошибка!")end end)end function q:InitData()local r=LocalPlayer()local s=self._lootingData if IsValid(self.frameItems)then self.frameItems:Close()end self.panelBase:Clear()local t=self.panelBase:Add("DButton")t:Dock(TOP)t:DockMargin(0,0,0,5)t:InvalidateParent(true)t:SetContentAlignment(5)t:SetFont("ui.Tahoma-7")t:SetText("Создать лут")t:SizeToContents()t.DoClick=function()self:InitLoading()d("lootingSystem.CreateLoot")e()end local u=self.panelBase:Add("DScrollPanel")u:Dock(FILL)u:InvalidateParent(true)for v,w in next,s do local x=w.index local y=u:Add("EditablePanel")y:Dock(TOP)y:SetTall(45)y:DockMargin(0,0,0,5)y:InvalidateParent(true)y.Paint=function(B,C,D)f(0,0,0,C,D,Color(0,0,0,150))end local z=y:Add("ixLabel")z:Dock(LEFT)z:DockMargin(5,5,5,5)z:SetFont("ui.Tahoma-7")z:SetText(w.index.." - "..w.name)z:SizeToContents()local A=y:Add("DButton")A:Dock(RIGHT)A:DockMargin(5,5,5,5)A:InvalidateParent(true)A:SetContentAlignment(5)A:SetFont("ui.Tahoma-7")A:SetText("Опции")A:SizeToContents()A.DoClick=function()local B=DermaMenu()B:AddOption("Переспавнить",function()d("lootingSystem.Respawn")g(x,32)e()end):SetImage("icon16/arrow_in.png")B:AddOption("Изменить",function()self:InitLoading()d("lootingSystem.EditFrame")g(x,32)e()end):SetImage("icon16/cog.png")B:AddOption("Удалить",function()Derma_StringRequest("Подтверждение","Введите 'УДАЛИТЬ' для подтверждения","",function(C)if C=="УДАЛИТЬ"then self:InitLoading()d("lootingSystem.RemoveLoot")g(x,32)e()end end)end):SetImage("icon16/cancel.png")B:Open()end end end function q:EditLoot(r,s)local t=LocalPlayer()self.panelBase:Clear()local u=self.panelBase:Add("EditablePanel")u:Dock(TOP)u:DockMargin(0,0,0,5)u:InvalidateParent(true)local v=u:Add("DButton")v:Dock(LEFT)v:InvalidateParent(true)v:SetContentAlignment(5)v:SetFont("ui.Tahoma-7")v:SetText("Назад")v:SizeToContents()v.DoClick=function()self:InitData()end local w=u:Add("DButton")w:Dock(FILL)w:DockMargin(5,0,5,0)w:InvalidateParent(true)w:SetContentAlignment(5)w:SetFont("ui.Tahoma-7")w:SetText("Сохранить")w:SizeToContents()w.DoClick=function()self:InitLoading("Сохранение...")d("lootingSystem.SaveLoot")g(r,32)h(s)e()end local x=u:Add("DButton")x:Dock(RIGHT)x:InvalidateParent(true)x:SetContentAlignment(5)x:SetFont("ui.Tahoma-7")x:SetText("DEBUG")x:SizeToContents()x.DoClick=function()PrintTable(s)end u:InvalidateParent(true)u:SizeToChildren(false,true)local y={{name="Название лута ( при наведении )",modifyKey="name",},{name="Описание лута ( при наведении )",modifyKey="desc",},{name="Время респавна в сек (дефолт 300)",modifyKey="resp",number=true,},{name="Рандомное добавочное время от - до + числа (дефолт 100)",modifyKey="respm",number=true,},}for A,B in next,y do local C=self.panelBase:Add("DTextEntry")C:Dock(TOP)C:DockMargin(0,0,0,5)C:InvalidateParent(true)C:SetFont("ui.Tahoma-8")C:SetValue(s[B.modifyKey]~=""and s[B.modifyKey]or"")C:SetPlaceholderText(B.name)C:SetCursorColor(color_white)C:SizeToContents()C:SetUpdateOnType(true)C.OnValueChange=function(D,E)s[B.modifyKey]=E end if B.number then C.AllowInput=p end end local z=self.panelBase:Add("DScrollPanel")z:Dock(FILL)z:InvalidateParent(true)self:CreateObjectsPanel(z,r,s)self:CreateItemsForOpenPanel(z,r,s)self:CreateItemsPanel(z,r,s)end function q:CreateObjectsPanel(r,s,t)local u=t.objects or{}local v=r:Add("EditablePanel")v:Dock(TOP)v:DockMargin(0,0,0,5)v:SetTall(self:GetTall()*.35)v:InvalidateParent(true)v.Paint=function(y,z,A)f(0,0,0,z,A,Color(0,0,0,100))end local w=v:Add("DScrollPanel")w:Dock(FILL)w:DockMargin(0,0,0,5)w:InvalidateParent(true)for y,z in next,u do local A=w:Add("EditablePanel")A:Dock(TOP)A:DockMargin(0,0,0,5)A:SetTall(42)A:InvalidateParent(true)A.Paint=function(E,F,G)f(0,0,0,F,G,Color(0,0,0,100))end local B=A:Add("SpawnIcon")B:Dock(LEFT)B:DockMargin(5,5,5,5)B:SetWide(32)B:SetModel(z.model)B:SetMouseInputEnabled(false)local C=A:Add("ixLabel")C:Dock(LEFT)C:DockMargin(5,5,5,5)C:SetFont("ui.Tahoma-7")C:SetText(z.model)C:SizeToContents()local D=A:Add("ixMenuButton")D:Dock(RIGHT)D:DockMargin(5,5,5,5)D:InvalidateParent(true)D:SetContentAlignment(5)D:SetBackgroundColor(Color(100,100,50))D:SetFont("ui.Tahoma-7")D:SetText("Опции")D:SizeToContents()D.DoClick=function(E)local F=DermaMenu()F:AddOption("Переместиться к объекту",function()d("lootingSystem.GotoObject")g(s,32)g(y,32)e()end):SetImage("icon16/anchor.png")F:AddOption("Удалить",function()Derma_StringRequest("Подтверждение","Введите 'УДАЛИТЬ' для подтверждения","",function(G)if G=="УДАЛИТЬ"then i(u,z)d("lootingSystem.SaveObjects")h({editableIndex=s,objects=u,})e()end end)end):SetImage("icon16/anchor.png")F:Open()end end local x=v:Add("ixMenuButton")x:Dock(BOTTOM)x:DockMargin(5,0,5,5)x:InvalidateParent(true)x:SetContentAlignment(5)x:SetBackgroundColor(Color(50,100,50))x:SetFont("ui.Tahoma-7")x:SetText("Изменить объекты")x:SizeToContents()x.DoClick=function()self:Close()d("lootingSystem.EditObjects")g(s,32)h(u)e()end end function q:InitItemPanel(r,s,t)local u=self.frameItems if IsValid(u)then return u:Close()end local v,w=self:GetPos()local x,y=self:GetSize()self:SetPos(v-x*0.35,w)v=v-x*0.35 self.frameItems=self:Add("DFrame")self.frameItems:SetTitle("Предметы")self.frameItems:SetPos(v+x+5,w)self.frameItems:SetSize(x*0.75,y)self.frameItems:MakePopup()self.frameItems.OnClose=function(A)if IsValid(self)then self:Center()end end self.frameItems.OnRemove=function(A)if IsValid(self)then self:Center()end end u=self.frameItems local z=u:Add("DTextEntry")z:Dock(TOP)z:DockMargin(0,0,0,5)z:InvalidateParent(true)z:SetFont("ui.Tahoma-8")z:SetValue("")z:SetPlaceholderText("Поиск по названию")z:SetCursorColor(color_white)z:SizeToContents()z:SetUpdateOnType(true)z.OnValueChange=function(A,B)u:ReloadList()end u.ReloadList=function(A)A.listView:Clear()local B=z:GetValue()B=j(B)local C=B==""for D,E in next,ix.item.list do if E.customItem then continue end local F=E.GetName and E:GetName()or E.Name if not C and not tostring(F):utf8lower():find(B:utf8lower())then continue end local G=A.listView:AddLine(F,E.category or L"none")G.item=E.uniqueID end end u.listView=u:Add("DListView")u.listView:Dock(FILL)u.listView:AddColumn(L"name").Header:SetTextColor(color_black)u.listView:AddColumn(L"category").Header:SetTextColor(color_black)u.listView:SetSkin("Default")u.listView.OnRowRightClick=function(A,B,C)t(C.item)end u:ReloadList()end function q:AddItemForOpen(r,s,t,u,v)local w=LocalPlayer()local x=ix.item.list[t]if x==nil then return w:Notify("not found uniqueID")end if not v then s.required=s.required or{}k(s.required,{uniqueID=t,bRemove=u,})end local y,z=x.width,x.height local A,B=32*y,32*z local C=x.GetName and x:GetName()or x.Name local D=r:Add("EditablePanel")D:Dock(TOP)D:SetTall(B+10)D:DockMargin(0,0,0,5)D:InvalidateParent(true)D.Paint=function(I,J,K)f(0,0,0,J,K,Color(0,0,0,150))end local E=D:Add("EditablePanel")E:Dock(LEFT)E:DockMargin(5,5,5,5)E:SetWide(A)E.Paint=function(I,J,K)f(0,0,0,J,K,Color(255,255,255,100))ix.stalkerInventory.DrawItemIcon(x,J,K,I)end local F=D:Add("ixLabel")F:Dock(LEFT)F:DockMargin(5,5,5,5)F:SetFont("ui.Tahoma-8")F:SetText(C)F:SizeToContents()local G=D:Add("ixLabel")G:Dock(LEFT)G:DockMargin(5,5,5,5)G:SetFont("ui.Tahoma-7")G:SetTextColor(u and Color(100,50,50)or Color(50,100,50))G:SetText(u and"Предмет будет удален"or"Предмет останется")G:SizeToContents()local H=D:Add("ixMenuButton")H:Dock(RIGHT)H:DockMargin(5,5,5,5)H:InvalidateParent(true)H:SetContentAlignment(5)H:SetBackgroundColor(Color(100,50,50))H:SetFont("ui.Tahoma-7")H:SetText("X")H:SizeToContents()H.DoClick=function()Derma_StringRequest("Подтверждение","Введите 'УДАЛИТЬ' для подтверждения","",function(I)if I=="УДАЛИТЬ"then for J,K in next,s.required do if K.uniqueID==t then l(s.required,J)break end end D:Remove()end end)end end function q:CreateItemsForOpenPanel(r,s,t)local u=LocalPlayer()local v=t.required or{}local w=r:Add("EditablePanel")w:Dock(TOP)w:DockMargin(0,0,0,5)w:SetTall(self:GetTall()*.35)w:InvalidateParent(true)w.Paint=function(z,A,B)f(0,0,0,A,B,Color(0,0,0,100))end local x=w:Add("DScrollPanel")x:Dock(FILL)x:DockMargin(0,0,0,5)x:InvalidateParent(true)for z,A in next,v do self:AddItemForOpen(x,t,A.uniqueID,A.bRemove,true)end local y=w:Add("ixMenuButton")y:Dock(BOTTOM)y:DockMargin(5,0,5,5)y:InvalidateParent(true)y:SetContentAlignment(5)y:SetBackgroundColor(Color(50,100,50))y:SetFont("ui.Tahoma-7")y:SetText("Добавить предмет для открытия")y:SizeToContents()y.DoClick=function()self:InitItemPanel(x,t,function(z)local A=t.required or{}for C,D in next,A do if D.uniqueID==z then return u:Notify("Предмет уже есть в списке!")end end local B=DermaMenu()B:AddOption("Добавить предмет",function()Derma_Query("Удалить предмет после открытия ?","Удалять предмет ?","Да",function()self:AddItemForOpen(x,t,z,true)end,"Нет",function()self:AddItemForOpen(x,t,z,false)end)end):SetImage("icon16/add.png")B:Open()end)end end function q:AddItemSpawn(r,s,t,u,v,w)local x=LocalPlayer()local y=ix.item.list[t]if y==nil then return x:Notify("not found uniqueID")end if not w then s.items=s.items or{}k(s.items,{uniqueID=t,procent=u,maxCount=v,})end local z,A=y.width,y.height local B,C=32*z,32*A local D=y.GetName and y:GetName()or y.Name local E=r:Add("EditablePanel")E:Dock(TOP)E:SetTall(C+10)E:DockMargin(0,0,0,5)E:InvalidateParent(true)E.Paint=function(K,M,N)f(0,0,0,M,N,Color(0,0,0,150))end local F=E:Add("EditablePanel")F:Dock(LEFT)F:DockMargin(5,5,5,5)F:SetWide(B)F.Paint=function(K,M,N)f(0,0,0,M,N,Color(255,255,255,100))ix.stalkerInventory.DrawItemIcon(y,M,N,K)end local G=E:Add("ixLabel")G:Dock(LEFT)G:DockMargin(5,5,5,5)G:SetFont("ui.Tahoma-8")G:SetText(D)G:SizeToContents()local H=E:Add("ixLabel")H:Dock(LEFT)H:DockMargin(5,5,5,5)H:SetFont("ui.Tahoma-8")H:SetText("MAX "..v)H:SizeToContents()local I=E:Add("ixLabel")I:Dock(LEFT)I:DockMargin(5,5,5,5)I:SetFont("ui.Tahoma-7")I:SetTextColor(Color(200,200,200))I:SetText("Шанс "..tostring(u).."%")I:SizeToContents()local J=E:Add("ixMenuButton")J:Dock(RIGHT)J:DockMargin(5,5,5,5)J:InvalidateParent(true)J:SetContentAlignment(5)J:SetBackgroundColor(Color(100,50,50))J:SetFont("ui.Tahoma-7")J:SetText("X")J:SizeToContents()J.DoClick=function()Derma_StringRequest("Подтверждение","Введите 'УДАЛИТЬ' для подтверждения","",function(K)if K=="УДАЛИТЬ"then for M,N in next,s.items do if N.uniqueID==t then l(s.items,M)break end end E:Remove()end end)end end function q:CreateItemsPanel(r,s,t)local u=LocalPlayer()local v=t.items or{}local w=r:Add("EditablePanel")w:Dock(TOP)w:DockPadding(5,5,5,0)w:DockMargin(0,0,0,5)w:SetTall(self:GetTall()*.35)w:InvalidateParent(true)w.Paint=function(B,C,D)f(0,0,0,C,D,Color(0,0,0,100))end local x=w:Add("DCheckBoxLabel")x:Dock(TOP)x:DockMargin(0,0,0,5)x:SetText("Отключить учитывание онлайна?")x:SetValue(t.itemsOnlineCheck or false)x:SizeToContents()x.OnChange=function(B,C)t.itemsOnlineCheck=C end local y=w:Add("DTextEntry")y:Dock(TOP)y:DockMargin(0,0,0,5)y:InvalidateParent(true)y:SetFont("ui.Tahoma-8")y:SetValue(t.itemsMax or"")y:SetPlaceholderText("Количество максимальных предметов в 1 контейнере (дефолт 1)")y:SetCursorColor(color_white)y:SizeToContents()y.AllowInput=p y:SetUpdateOnType(true)y.OnValueChange=function(B,C)t.itemsMax=C end local z=w:Add("DScrollPanel")z:Dock(FILL)z:DockMargin(0,0,0,5)z:InvalidateParent(true)for B,C in next,v do self:AddItemSpawn(z,t,C.uniqueID,C.procent,(C.maxCount or 1),true)end local A=w:Add("ixMenuButton")A:Dock(BOTTOM)A:InvalidateParent(true)A:SetContentAlignment(5)A:SetBackgroundColor(Color(50,100,50))A:SetFont("ui.Tahoma-7")A:SetText("Добавить предметы для спавна")A:SizeToContents()A.DoClick=function()self:InitItemPanel(z,t,function(B)local C=t.items or{}for E,F in next,C do if F.uniqueID==B then return u:Notify("Предмет уже есть в списке!")end end local D=DermaMenu()D:AddOption("Добавить предмет для спавна",function()Derma_StringRequest("Добавление предмета","Введите вероятность появления в процентах (1 - 100)","0",function(E)if not tonumber(E)then return Derma_Message("Используйте числа","Ошибка","Понятно")end Derma_StringRequest("Количество предметов","Введите масимально возможное кол-во спавна","1",function(F)if not tonumber(F)then return Derma_Message("Используйте числа","Ошибка","Понятно")end E=m(E,1,100)F=m(F,1,100)self:AddItemSpawn(z,t,B,E,F)end)end)end):SetImage("icon16/add.png")D:Open()end)end end n("looting.AdminMenu",q,"DFrame")if IsValid(ix.gui.lootingAdminMenu)then ix.gui.lootingAdminMenu:Remove()end