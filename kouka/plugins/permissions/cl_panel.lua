-- <|> Hello, fucker | Taxin2012 and PURP was here | Mysterious Zone Project | mzrp.ru <|>
local a=KoukaPlugin a:Hook("Kouka.PluginsLoaded",function()kouka.CallPluginMethod("modular_menu","AddMenu","Tags & Flags",{Init=function(b)local c=b:Add("DPropertySheet")c:Dock(FILL)b.dPropertySheet=c if kouka.HasFlag("Get User Tags")then local d=c:Add("DPanel")d.Paint=function()end c:AddSheet("User Tags",d,"icon16/user.png")b.tagsDPanel=d local e=d:Add("DScrollPanel")e:Dock(FILL)e:DockPadding(4,4,4,4)e:DockMargin(0,0,0,4)e.checkBoxes={}e.selectedTags={}d.dScrollPanel=e local f=d:Add("DTextEntry")f:SetTall(30)f:SetPlaceholderText("SteamID")f:Dock(BOTTOM)f.OnEnter=function(this)local h=string.Trim(this:GetValue())this:SetText("Getting info...")this:SetEnabled(false)this:SetEnterAllowed(false)local i=false if kouka.utils.IsSteamID32(h)then h=util.SteamIDTo64(h)if h~="0"then i=true end elseif kouka.utils.IsSteamID64(h)then i=true end if i then net.Start("Kouka.Permissions.Get")net.WriteUInt(0,2)net.WriteString(h)net.SendToServer()this.lastSID=h else this:SetText("Error, use only SteamID32/64")this:SetEnabled(true)this:SetEnterAllowed(true)end end b.UpdateTags=function(h)timer.Simple(1.2,function()if IsValid(b)then a.hashMap.RequestTags()end end)end if b.strParam~=nil then local h=Player(b.strParam)f:SetText((IsValid(h)and h:SteamID64())or b.strParam)f:OnEnter()b.UpdateTags()else f:RequestFocus()a.hashMap.RequestTags()end d.dTextEntry=f local g=d:Add("DButton")g:SetVisible(false)g:SetTall(30)g:SetText("Apply User Tags")g:Dock(BOTTOM)g.DoClick=function(h)if f.lastSID then local i={}for j,k in pairs(e.selectedTags)do i[#i+1]=k!=false&&j||nil end PrintTable(i)net.Start("Kouka.Permissions.Set")net.WriteUInt(0,2)net.WriteString(f.lastSID)kouka.utils.WriteList(i,net.WriteString)net.SendToServer()f.lastSID=nil end e.selectedTags={}for i,j in next,e.checkBoxes do j:Remove()end g:SetVisible(false)end d.dButton=g end if kouka.HasFlag("Get Tags")then local d=c:Add("DPanel")c:AddSheet("Tags Edit",d,"icon16/tag_blue.png")b.flagsDPanel=d local e=d:Add("DListView")e:SetMultiSelect(false)e:Dock(FILL)e:AddColumn("Tag")e:AddColumn("Immunity")e:AddColumn("Creator")e:AddColumn("Date")d.dListView=e local f=d:Add("DButton")f:SetTall(30)f:SetText("Create New")f:Dock(BOTTOM)f.DoClick=function(g)Derma_StringRequest("Kouka | Create a new Tag","Enter a new Tag name:","",function(h)net.Start("Kouka.Permissions.Create")net.WriteString(h)net.SendToServer()b.UpdateTags()end)end d.dButton=f end if kouka.HasFlag("Get User Tags")then local d=c:Add("DPanel")c:AddSheet("Search users by Tag",d,"icon16/tag_blue.png")b.tagsUserDPanel=d local e=d:Add("DListView")e:SetMultiSelect(false)e:Dock(FILL)e:AddColumn("Name")e:AddColumn("SteamID")e:AddColumn("SteamID64")b.dListView2=e local f=d:Add("DTextEntry")f:SetTall(30)f:SetPlaceholderText("Tag name")f:Dock(BOTTOM)f:DockMargin(0,5,0,0)f.OnEnter=function(this)local g=string.Trim(this:GetValue())this:SetText("Getting info...")this:SetEnabled(false)this:SetEnterAllowed(false)net.Start("Kouka.Permissions.Get")net.WriteUInt(3,2)net.WriteString(g)net.SendToServer()end b.dTextEntry2=f b.UpdateTagUsers=function(g,h,i)timer.Simple(i or 1.2,function()if IsValid(b)then f:SetText(h)f:OnEnter()end end)end end end,OnUpdate=function(b,c,d,e,f)if c==0 then local g=b.tagsDPanel local h=g.dScrollPanel local i=h.checkBoxes for k,l in next,i do l:Remove()end local j={}for k,l in next,e do j[k]=false end for k,l in next,d do j[l]=true end for k,l in next,j do local m=h:Add("DCheckBoxLabel")m:Dock(TOP)m:SetText(k)m:DockMargin(0,0,0,4)m:SetChecked(l)m:SetFont("Trebuchet24")m.OnChange=function(n,o)h.selectedTags[k]=o end if l then h.selectedTags[k]=l end i[#i+1]=m end g.dButton:SetVisible(true)g.dTextEntry:SetText("")g.dTextEntry:SetEnabled(true)g.dTextEntry:SetEnterAllowed(true)elseif c==1 then b.flagsDPanel.dListView:Clear()for g,h in next,d do local i=h.creator local j=b.flagsDPanel.dListView:AddLine(g,h.immunity,i,kouka.utils.RelativeDate(h.date))j.OnRightClick=function()local k=DermaMenu(this)local l,m=k:AddSubMenu("Creator")m:SetImage("icon16/user_comment.png")l:AddOption("Copy SteamID32",function()SetClipboardText(util.SteamIDFrom64(i))end):SetImage("icon16/tag_blue_add.png")l:AddOption("Copy SteamID64",function()SetClipboardText(i)end):SetImage("icon16/tag_blue_add.png")l:AddOption("Copy profile link",function()SetClipboardText("https://steamcommunity.com/profiles/"..i)end):SetImage("icon16/vcard_add.png")l:AddOption("Open profile",function()gui.OpenURL("https://steamcommunity.com/profiles/"..i)end):SetImage("icon16/vcard.png")k:AddSpacer()if kouka.HasFlag("Get Tags")then k:AddOption("Edit Flags",function()net.Start("Kouka.Permissions.Get")net.WriteUInt(2,2)net.WriteString(g)net.SendToServer()end):SetImage("icon16/tag_blue_edit.png")end if kouka.HasFlag("Edit Tags")then k:AddOption("Edit Immunity",function()Derma_StringRequest("Kouka | Edit tag Immunity","Enter a new tag Immunity number (0-100):",h.immunity,function(n)local o=tonumber(n)if o~=nil and o~=h.immunity then if o<0 or o>99 then return kouka.Notify(kouka.colors.red,"Immunity number should be bigger or equal 0 and lower than 100")end net.Start("Kouka.Permissions.Set")net.WriteUInt(2,2)net.WriteString(g)net.WriteUInt(o,8)net.SendToServer()end end)end):SetImage("icon16/tag_blue_edit.png")end k:AddSpacer()if kouka.HasFlag("Get User Tags")then k:AddOption("Search users",function()b.dPropertySheet:SetActiveTab(b.dPropertySheet:GetItems()[3].Tab)b:UpdateTagUsers(g,0)end):SetImage("icon16/find.png")k:AddSpacer()end if kouka.HasFlag("Delete Tags")then local n,o=k:AddSubMenu("Delete")o:SetImage("icon16/tag_blue_delete.png")n:AddOption("Confirm",function()net.Start("Kouka.Permissions.Delete")net.WriteUInt(0,1)net.WriteString(g)net.SendToServer()end):SetImage("icon16/delete.png")end k:Open()end end elseif c==2 then local g=vgui.Create("DFrame")g:SetSize(b:GetWide()*.8,b:GetTall()*.8)g:Center()g:SetTitle("Edit Tag | "..d)g:MakePopup()g:SetParent(b)local h=g:Add("DScrollPanel")h:Dock(FILL)h:DockPadding(4,4,4,4)h:DockMargin(0,0,0,4)local i={}for k,l in next,f do i[k]=false end for k,l in next,e do i[l]=true end for k,l in SortedPairs(i)do local m=h:Add("DCheckBoxLabel")m:Dock(TOP)m:SetText(k)m:DockMargin(0,0,0,4)m:SetChecked(l)m:SetFont("Trebuchet24")local n=f[k]if n~=nil and kouka.HasFlag(k,true)==false then m:SetEnabled(false)end if n==nil then m:SetTextColor(kouka.colors.red)elseif n==false then m:SetTextColor(kouka.colors.yellow)end m.OnChange=function(o,p)i[k]=p end end local j=g:Add("DButton")j:SetText("Apply")j:Dock(BOTTOM)j:DockMargin(0,15,0,0)j.DoClick=function(k)kouka.utils.RemoveByValue(i,false)kouka.utils.KeysToValues(i)net.Start("Kouka.Permissions.Set")net.WriteUInt(1,2)net.WriteString(d)kouka.utils.WriteList(i,net.WriteString)net.SendToServer()g:Remove()end elseif c==3 then local g=b.dTextEntry2 b.dListView2:Clear()for h,i in next,e do local j=util.SteamIDFrom64(h)local k=b.dListView2:AddLine(i,h,j)k.OnRightClick=function(this)local l=DermaMenu(this)local m,n=l:AddSubMenu("User")n:SetImage("icon16/user_comment.png")m:AddOption("Copy Name",function()SetClipboardText(i)end):SetImage("icon16/tag_blue_add.png")m:AddOption("Copy SteamID32",function()SetClipboardText(j)end):SetImage("icon16/tag_blue_add.png")m:AddOption("Copy SteamID64",function()SetClipboardText(h)end):SetImage("icon16/tag_blue_add.png")m:AddOption("Copy profile link",function()SetClipboardText("https://steamcommunity.com/profiles/"..h)end):SetImage("icon16/vcard_add.png")m:AddOption("Open profile",function()gui.OpenURL("https://steamcommunity.com/profiles/"..h)end):SetImage("icon16/vcard.png")if kouka.HasFlag("Edit User Tags")then local o,p=l:AddSubMenu("Remove tag")p:SetImage("icon16/lightning.png")o:AddOption("Confirm",function()net.Start("Kouka.Permissions.Delete")net.WriteUInt(1,1)net.WriteString(d)net.WriteString(h)net.SendToServer()b:UpdateTagUsers(d)end):SetImage("icon16/delete.png")end l:Open()end end g:SetText("")g:SetEnabled(true)g:SetEnterAllowed(true)end end})end)net.Receive("Kouka.Permissions.Get",function()local b=net.ReadUInt(2)local c,d,e if b==0 then c=kouka.utils.ReadList(net.ReadString)d=kouka.utils.ReadKeyList(net.ReadString)elseif b==1 then c={}kouka.utils.ReadList(function()c[net.ReadString()]={immunity=net.ReadUInt(8),creator=net.ReadString(),date=net.ReadUInt(32)}end,nil,true)elseif b==2 then c=net.ReadString()d=kouka.utils.ReadList(net.ReadString)e={}kouka.utils.ReadList(function()e[net.ReadString()]=net.ReadBool()end,nil,true)elseif b==3 then c,d=net.ReadString(),{}kouka.utils.ReadList(function()d[net.ReadString()]=net.ReadString()end,nil,true)end kouka.CallPluginMethod("modular_menu","UpdateMenu","Tags & Flags",b,c,d,e)end)