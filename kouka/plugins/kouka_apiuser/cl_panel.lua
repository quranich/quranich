-- <|> Hello, fucker | Taxin2012 and PURP was here | Mysterious Zone Project | mzrp.ru <|>
local a=KoukaPlugin a:Hook("Kouka.PluginsLoaded",function()kouka.CallPluginMethod("modular_menu","AddMenu","APIUser List",{Init=function(b)local c=b:Add("DListView")c:SetMultiSelect(false)c:Dock(FILL)c:AddColumn("Name")c:AddColumn("ID")c:AddColumn("IP")c:AddColumn("Status")c:AddColumn("Last Login")c:AddColumn("Last Server")c:AddColumn("Credits")c:AddColumn("B. Credits")c:AddColumn("Joined")b.dListView=c local d=b:Add("DTextEntry")d:SetTall(30)d:SetPlaceholderText("SteamID/IP")d:Dock(BOTTOM)d:DockMargin(0,5,0,0)d.OnEnter=function(e)local f=string.Trim(e:GetValue())e:SetText("Getting info...")e:SetEnabled(false)e:SetEnterAllowed(false)local g=false if kouka.utils.IsSteamID32(f)then f=util.SteamIDTo64(f)if f~="0"then g=true end end if g or kouka.utils.IsSteamID64(f)then net.Start("Kouka.APIUser.List")net.WriteUInt(0,2)net.WriteBool(true)net.WriteString(f)net.SendToServer()elseif kouka.utils.IsIP(f)then net.Start("Kouka.APIUser.List")net.WriteUInt(0,2)net.WriteBool(false)kouka.utils.WriteIP(f)net.SendToServer()else e:SetText("Error, use only SteamID32/64 or IP")e:SetEnabled(true)e:SetEnterAllowed(true)end end b.dTextEntry=d b.UpdateWithTarget=function(e,f,g)timer.Simple((g and 0)or 2.2,function()if IsValid(b)then b.dTextEntry:SetText(f)b.dTextEntry:OnEnter()end end)end if b.strParam~=nil then local e=Player(b.strParam)b:UpdateWithTarget((IsValid(e)and e:SteamID64())or b.strParam,true)else d:RequestFocus()end end,OnUpdate=function(b,c)b.dListView:Clear()if c~=nil then local d,e=os.time(),kouka.HasFlag("See IP APIUserList")for f,g in next,c do local h=b.dListView:AddLine(g.username,g._id,(e and g.last_ip)or"HIDDEN",g.status,kouka.utils.RelativeDate(g.last_login),g.last_server,g.credits,g.bonus_credits,kouka.utils.RelativeDate(g.date_joined))h.OnRightClick=function(i)local j=DermaMenu(i)local k,l=j:AddSubMenu("SteamID")l:SetImage("icon16/user.png")k:AddOption("Copy SteamID32",function()SetClipboardText(util.SteamIDFrom64(g._id))end):SetImage("icon16/tag_blue_add.png")k:AddOption("Copy SteamID64",function()SetClipboardText(g._id)end):SetImage("icon16/tag_blue_add.png")k:AddOption("Copy profile link",function()SetClipboardText("https://steamcommunity.com/profiles/"..g._id)end):SetImage("icon16/vcard_add.png")k:AddOption("Open profile",function()gui.OpenURL("https://steamcommunity.com/profiles/"..g._id)end):SetImage("icon16/vcard.png")if e then j:AddSpacer()local m,n=j:AddSubMenu("IP")n:SetImage("icon16/building.png")m:AddOption("Copy IP",function()SetClipboardText(g.last_ip)end):SetImage("icon16/building_add.png")local o,p=m:AddSubMenu("Find by IP")p:SetImage("icon16/building_go.png")o:AddOption("Confirm",function()b:UpdateWithTarget(g.last_ip,true)end):SetImage("icon16/error.png")local q,r=m:AddSubMenu("IP Lookup")r:SetImage("icon16/building_key.png")q:AddOption("Confirm",function()http.Fetch("http://ip-api.com/json/"..g.last_ip.."?fields=status,country,regionName,city,isp,mobile,proxy",function(s)if s~=nil then local t=util.JSONToTable(s)if t~=nil and t.status=="success"then return Derma_Message(string.format("Country: %s\nRegion: %s\nCity: %s\nISP: %s\nMobile: %s\nProxy (VPN): %s\n",t.country,t.regionName,t.city,t.isp,(t.mobile and"Yes")or"No",(t.proxy and"Yes")or"No"),"IP Lookup | "..g.last_ip,"OK")end end Derma_Message("Error","IP Lookup | "..g.last_ip,"OK")end,function(s)Derma_Message("Error: "..s,"IP Lookup | "..g.last_ip,"OK")end)end):SetImage("icon16/error.png")j:AddSpacer()end if kouka.HasFlag("Edit APIUserList")then j:AddOption("Edit Credits",function()Derma_StringRequest("Edit Credits | "..g._id,"Enter new value:",g.credits,function(m)local n=tonumber(m)if n then net.Start("Kouka.APIUser.List")net.WriteUInt(1,2)net.WriteString(g._id)net.WriteUInt(n,18)net.SendToServer()b.dTextEntry:SetText("Edit request sent")b:UpdateWithTarget(g._id)else b.dTextEntry:SetText("Error")end end)end):SetImage("icon16/link_edit.png")j:AddOption("Edit Bonus Credits",function()Derma_StringRequest("Edit Bonus Credits | "..g._id,"Enter new value:",g.bonus_credits,function(m)local n=tonumber(m)if n then net.Start("Kouka.APIUser.List")net.WriteUInt(3,2)net.WriteString(g._id)net.WriteUInt(n,18)net.SendToServer()b.dTextEntry:SetText("Edit request sent")b:UpdateWithTarget(g._id)else b.dTextEntry:SetText("Error")end end)end):SetImage("icon16/link_edit.png")end if kouka.HasFlag("Delete APIUserList")then local m,n=j:AddSubMenu("Delete")n:SetImage("icon16/link_delete.png")m:AddOption("Confirm",function()net.Start("Kouka.APIUser.List")net.WriteUInt(2,2)net.WriteString(g._id)net.SendToServer()b.dTextEntry:SetText("Delete request sent")b:UpdateWithTarget(g._id)end):SetImage("icon16/delete.png")end j:Open()end end end b.dTextEntry:SetText((c~=nil and"")or"Error")b.dTextEntry:SetEnabled(true)b.dTextEntry:SetEnterAllowed(true)end})end)