-- <|> Hello, fucker | Taxin2012 and PURP was here | Mysterious Zone Project | mzrp.ru <|>
local a=ix.plugin.list["inventory-module-vendor-dlc-dialogs"]local b={}function b:Init()local d=LocalPlayer()if kouka.HasFlag("Helix - Manage Dialogs")==false then return self:Remove()end if IsValid(ix.gui.adminMenuDialogs)then ix.gui.adminMenuDialogs:Close()end local e,f=ScrW(),ScrH()self:SetTitle("Диалоги - Админ меню")self:SetSize(e*0.5,f*0.75)self:Center()self:MakePopup()self:SetSkin("Default")ix.gui.adminMenuDialogs=self self.panelBase=self:Add("EditablePanel")self.panelBase:Dock(FILL)self.panelBase:InvalidateParent(true)end function b:InitLoading(d)self.panelBase:Clear()local e=self.panelBase:Add("EditablePanel")e:Dock(FILL)e.Paint=function(f,g,h)draw.DrawText((d or"Пожалуйста подождите..."),"ui.Tahoma-9",g*.5,h*.5,color_white,TEXT_ALIGN_CENTER)end timer.Simple(10,function()if IsValid(self)and IsValid(e)then self:Remove()return LocalPlayer():Notify("Ошибка!")end end)end function b:InitData(d)self.panelBase:Clear()if not d then Derma_Message("Ошибка: Не удалось получить базу данных.","ОШИБКА","Закрыть")self:Close()return end self.tableData=d local e=game.GetMap(true)if table.HasValue(self.tableData,e)==false then table.insert(self.tableData,e)end self.propertySheet=vgui.Create("DPropertySheet",self.panelBase)self.propertySheet:Dock(FILL)for f,g in next,d do self:CreateTabMap(g)end end function b:CreateTabMap(d)local e=game.GetMap(true)==d and"(Текущая) - "..d or d local f=self.propertySheet:Add("EditablePanel")local g=f:Add("EditablePanel")g:Dock(TOP)g:DockMargin(0,0,0,5)g:InvalidateParent(true)local h=g:Add("DButton")h:Dock(FILL)h:DockMargin(0,0,5,0)h:InvalidateParent(true)h:SetFont("ui.Tahoma-7")h:SetText("Создать новый диалог")h:SizeToContents()h.DoClick=function(k)self:InitCreateEditFrame()end local i=g:Add("DButton")i:Dock(RIGHT)i:InvalidateParent(true)i:SetFont("ui.Tahoma-7")i:SetText("Обновить данные")i:SizeToContents()g:InvalidateParent(true)g:SizeToChildren(false,true)local j=f:Add("DScrollPanel")j:Dock(FILL)j.isLoading=true j.UpdateData=function(k,l)k:Clear()k.isLoading=nil for m,n in next,l do local o=j:Add("EditablePanel")o:Dock(TOP)o:DockMargin(0,0,0,5)o:SetTall(self:GetTall()*.05)o.Paint=function(t,u,v)draw.RoundedBox(4,0,0,u,v,Color(40,40,40,200))end local p=o:Add("DLabel")p:Dock(LEFT)p:DockMargin(self:GetWide()*.01,0,0,0)p:SetTextColor(Color(190,190,190))p:SetText(n._id)p:SetFont("ui.Tahoma-6")local q=o:Add("DLabel")q:Dock(LEFT)q:DockMargin(self:GetWide()*.01,0,0,0)q:SetTextColor(color_white)q:SetText(n.name)q:SetFont("ui.Tahoma-7")q:SizeToContents()local r=o:Add("DLabel")r:Dock(LEFT)r:DockMargin(self:GetWide()*.01,0,0,0)r:SetTextColor(Color(190,190,190))r:SetText(n.description)r:SetFont("ui.Tahoma-7")r:SizeToContents()local s=o:Add("DButton")s:Dock(RIGHT)s:SetFont("ui.Tahoma-7")s:SetText("Опции")s.DoClick=function(t)local u=DermaMenu()u:AddOption("Скопировать UID",function()SetClipboardText(n._id)end):SetImage("icon16/textfield_rename.png")u:AddOption("Изменить",function()self:InitCreateEditFrame(n)end):SetImage("icon16/cog.png")u:AddOption("Дублировать",function()ix.gui.adminMenuDialogs:InitLoading("Дублирование диалога...")kouka.utils.Stream.Start("dialogSystem_Dublicate",{data=n.data,description=n.description.." - [Д]",name=n.name.." - [Д]"})end):SetImage("icon16/comments.png")u:AddOption("Удалить",function()ix.gui.adminMenuDialogs:InitLoading("Удаление диалога...")net.Start("dialogSystem_Remove")net.WriteString(n._id)net.SendToServer()end):SetImage("icon16/bin.png")u:Open()end end end j.Paint=function(k,l,m)if k.isLoading then draw.SimpleText("Загрузка таблицы...","ui.Tahoma-7",l*.5,m*.5,color_white,TEXT_ALIGN_CENTER,TEXT_ALIGN_CENTER)end end i.DoClick=function()if(LocalPlayer().nextAPIAction or 0)>CurTime()then return LocalPlayer():Notify("Необходимо подождать")end if IsValid(j)then j.isLoading=true j:Clear()ix.dlc_vendor.dialogs.ReadApi("maps/"..d,function(k)if IsValid(j)then j:UpdateData(k)end end)end end timer.Simple(1,function()ix.dlc_vendor.dialogs.ReadApi("maps/"..d,function(k)if IsValid(j)then j:UpdateData(k)end end)end)self.propertySheet:AddSheet(e,f)end function b:InitCreateEditFrame(d)self.panelBase:Clear()d=d or{}local e={_id=d._id,name=d.name or"",description=d.description or"",map_name=d.map_name,stages=d.data or{},}local f=self.panelBase:Add("EditablePanel")f:Dock(TOP)f:DockMargin(0,0,0,5)f:InvalidateParent(true)local g=f:Add("DButton")g:Dock(FILL)g:SetContentAlignment(5)g:DockMargin(0,0,0,0)g:InvalidateParent(true)g:SetFont("ui.Tahoma-7")g:SetText("Сохранить")g:SizeToContents()g.DoClick=function(o)ix.gui.adminMenuDialogs:InitLoading("Сохранение диалога...")kouka.utils.Stream.Start("dialogSystem_SaveDialog",e)end local h=f:Add("DButton")h:Dock(LEFT)h:DockMargin(0,0,5,0)h:InvalidateParent(true)h:SetContentAlignment(5)h:SetFont("ui.Tahoma-7")h:SetText("Назад")h:SizeToContents()h.DoClick=function(o)self:InitData(self.tableData)end f:InvalidateParent(true)f:SizeToChildren(false,true)local i=self.panelBase:Add("EditablePanel")i:Dock(TOP)i:DockMargin(0,0,0,5)i:InvalidateParent(true)local j=i:Add("DTextEntry")j:Dock(TOP)j:DockMargin(0,0,0,5)j:InvalidateParent(true)j:SetValue(e.name or"")j:SetPlaceholderText("Краткое название диалога")j:SetUpdateOnType(true)j.OnValueChange=function(o,p)p=string.Replace(p,"\n"," ")e.name=p end local k=i:Add("DTextEntry")k:Dock(TOP)k:DockMargin(0,0,0,5)k:InvalidateParent(true)k:SetValue(e.description or"")k:SetPlaceholderText("Краткое описание диалога")k:SetUpdateOnType(true)k.OnValueChange=function(o,p)p=string.Replace(p,"\n"," ")e.description=p end i:InvalidateParent(true)i:SizeToChildren(false,true)local l=self.panelBase:Add("EditablePanel")l:Dock(TOP)l:DockPadding(3,3,3,3)l:SetTall(self:GetTall()*.06)l.Paint=function(o,p,q)draw.RoundedBox(0,0,0,p,q,Color(40,40,40,200))end local m=l:Add("DHorizontalScroller")m:Dock(FILL)m:SetOverlap(-5)m.UpdateStages=function(o,p)o:Clear()for q,r in next,p.stages do local s=self:AddStageButton(m,q,e)m:AddPanel(s)end end local n=l:Add("DButton")n:Dock(RIGHT)n:SetContentAlignment(5)n:DockMargin(3,0,0,0)n:SetFont("ui.Tahoma-7")n:SetText("Создать этап")n:SizeToContents()n.DoClick=function()table.insert(e.stages,{dialog="",ansfers={},})m:UpdateStages(e)end m:UpdateStages(e)self.panelBase.panelStageData=self.panelBase:Add("EditablePanel")self.panelBase.panelStageData:Dock(FILL)end function b:AddStageButton(d,e,f)local g=d:Add("DButton")g:Dock(LEFT)g:DockMargin(0,0,5,0)g:InvalidateParent(true)g:SetFont("ui.Tahoma-7")g:SetText(e)g:SizeToContents()g.DoClick=function()local h=DermaMenu()h:AddOption("Выбрать",function()self:SelectStage(f,e)end):SetImage("icon16/anchor.png")h:AddOption("Удалить",function()table.remove(f.stages,e)d:UpdateStages(f)if self.selectedStage==e then local i=self.panelBase.panelStageData if IsValid(i)then i:Clear()end end end):SetImage("icon16/cancel.png")h:Open()end g:InvalidateParent(true)g:SetWide(math.max(g:GetWide(),g:GetTall()))return g end function b:SelectStage(d,e)local f=self.panelBase.panelStageData local g=d.stages[e]self.selectedStage=e f:Clear()self:SetTitle("Этап - "..e)local h=f:Add("DTextEntry")h:Dock(FILL)h:SetWide(self:GetWide()*0.9)h:DockMargin(0,5,0,0)h:SetMultiline(true)h:SetFont("ui.Tahoma-7")h:SetValue(g.dialog or"")h:SetPlaceholderText("Диалог NPC")h:SetUpdateOnType(true)h.OnValueChange=function(l,m)g.dialog=m end local i=f:Add("EditablePanel")i:Dock(BOTTOM)i:DockMargin(0,5,0,0)i:SetTall(self:GetTall()*.3)local j=i:Add("DScrollPanel")j:Dock(FILL)j:DockMargin(0,5,0,0)j:GetCanvas():DockPadding(5,5,5,5)j.Paint=function(l,m,n)draw.RoundedBox(0,0,0,m,n,Color(40,40,40,200))end j.UpdateAnsfers=function(l)l:Clear()for m,n in next,g.ansfers do local o=l:Add("DPanel")o:Dock(TOP)o:DockMargin(0,0,0,5)o:DockPadding(5,5,5,5)o:InvalidateParent(true)o:SetTall(self:GetTall()*.05)local p=o:Add("DTextEntry")p:Dock(FILL)p:InvalidateParent(true)p:SetValue(n.message or"")p:SetPlaceholderText("Текст который говорит игрок")p:SetUpdateOnType(true)p.OnValueChange=function(t,u)u=string.Replace(u,"\n"," ")g.ansfers[m].message=u end local q=o:Add("DButton")q:Dock(RIGHT)q:InvalidateParent(true)q:SetText("Удалить")q:SizeToContents()q.DoClick=function()table.remove(g.ansfers,m)o:Remove()end local r=o:Add("DTextEntry")r:Dock(RIGHT)r:DockMargin(5,0,5,0)r:InvalidateParent(true)r:SetValue(n.nextStage or 0)r:SetPlaceholderText("этап")r:SetUpdateOnType(true)r.AllowInput=function(t,u)if not string.find("1234567890",u,1,true)then return true end return false end r.OnValueChange=function(t,u)u=string.Replace(u,"\n"," ")g.ansfers[m].nextStage=u end local s=o:Add("DButton")s:Dock(RIGHT)s:DockMargin(5,0,0,0)s:InvalidateParent(true)s:SetText("Установить задание")s:SizeToContents()s.DoClick=function(t)Derma_StringRequest("Задние _id","ВВедите _id задания","",function(u)if u==""then g.ansfers[m].questID=nil t:SetText("Установить задание")t:SizeToContents()return end t:SetText("Задание: "..u)t:SizeToContents()g.ansfers[m].questID=u end)end if n.questID then s:SetText("Задание: "..n.questID)s:SizeToContents()end end end local k=i:Add("DButton")k:Dock(TOP)k:SetFont("ui.Tahoma-7")k:SetText("Создать ответ на диалог")k:SizeToContents()k.DoClick=function(l)table.insert(g.ansfers,{message="",nextStage=0,})j:UpdateAnsfers()end j:UpdateAnsfers()end vgui.Register("dialogs.admin-menu",b,"DFrame")if IsValid(ix.gui.adminMenuDialogs)then ix.gui.adminMenuDialogs:Remove()ix.command.Send("dialogsadminmenu")end local c={}function c:Init()if kouka.HasFlag("Helix - Manage Dialogs")==false then return self:Remove()end local d,e=ScrW(),ScrH()self:SetSize(d*0.3,e*0.75)self:Center()self:MakePopup()self:SetTitle(L"vendorEditor")end function c:InitFrame(d)if not IsValid(d)then return self:Remove()end local e=self:Add("DLabel")e:Dock(TOP)e:DockMargin(0,0,0,0)e:SetText("После ввода значения используйте ENTER для сохранения")e:InvalidateParent(true)self.name=self:Add("DTextEntry")self.name:Dock(TOP)self.name:InvalidateParent(true)self.name:SetText(d:GetDisplayName())self.name:SetPlaceholderText(L"name")self.name.OnEnter=function(g)if(d:GetDisplayName()!=g:GetText())then self:updateVendor("name",g:GetText())end end self.description=self:Add("DTextEntry")self.description:Dock(TOP)self.description:DockMargin(0,4,0,0)self.description:InvalidateParent(true)self.description:SetText(d:GetDescription())self.description:SetPlaceholderText(L"description")self.description.OnEnter=function(g)if(d:GetDescription()!=g:GetText())then self:updateVendor("description",g:GetText())end end self.model=self:Add("DTextEntry")self.model:Dock(TOP)self.model:DockMargin(0,4,0,0)self.model:InvalidateParent(true)self.model:SetText(d:GetModel())self.model:SetPlaceholderText(L"model")self.model.OnEnter=function(g)if(d:GetModel():lower()!=g:GetText():lower())then self:updateVendor("model",g:GetText():lower())end end self.dialog=self:Add("DTextEntry")self.dialog:Dock(TOP)self.dialog:DockMargin(0,4,0,0)self.dialog:InvalidateParent(true)self.dialog:SetText(d:GetNWString("dialogIndex"))self.dialog:SetPlaceholderText("uid диалога")self.dialog.OnEnter=function(g)if d:GetNWString("dialogIndex"):lower()~=g:GetText():lower()then self:updateVendor("dialogIndex",g:GetText():lower())end end self.disableVoice=self:Add("DCheckBoxLabel")self.disableVoice:SetText("Отключить голос")self.disableVoice:Dock(TOP)self.disableVoice:DockMargin(0,4,0,0)self.disableVoice:InvalidateParent(true)self.disableVoice:SetChecked(d:GetNWBool("disableVoice"))self.disableVoice.OnChange=function(g,h)self:updateVendor("disableVoice",h)end local f={}hook.Run("VendorDLC.EditorFrame",f)if table.Count(f)>0 then self.bDLC=self:Add("DButton")self.bDLC:SetText("Дополнения →")self.bDLC:Dock(TOP)self.bDLC:DockMargin(0,4,0,0)self.bDLC:InvalidateParent(true)self.bDLC:SetTextColor(color_white)self.bDLC:SizeToContents()self.bDLC.DoClick=function(g)self:ToggleDLCFrame(f)end end self:InvalidateParent(true)self:SizeToChildren(false,true)self:Center()end function c:ToggleDLCFrame(d)local e=self.dlc_frame if IsValid(e)then e:Close()return end self:Center()local f=self:GetWide()*0.5 local g,h=self:GetPos()local i,j=self:GetSize()self:SetPos(g-f*0.5,h)g=select(1,self:GetPos())self.dlc_frame=self:Add("DFrame")self.dlc_frame:SetTitle("Дополнения")self.dlc_frame:SetPos(g+i+5,h)self.dlc_frame:SetSize(f*2,j*2.75)self.dlc_frame:MakePopup()self.dlc_frame.OnClose=function(k)self:Center()end self.dlc_frame:SetPos(g+i+5,h-((j*2.75)*.25))self.scroll_panel=self.dlc_frame:Add("DScrollPanel")self.scroll_panel:Dock(FILL)for k,l in pairs(d)do if l.draw_editor then local m=l.name or"#name"local n=vgui.Create("DCollapsibleCategory",self.scroll_panel)n:SetLabel(m)n:Dock(TOP)n.Paint=function(o,p,q)draw.RoundedBox(0,0,o.Header:GetTall(),p,q-o.Header:GetTall(),Color(40,40,40,200))draw.RoundedBox(0,0,0,p,o.Header:GetTall(),ix.config.Get("color"))end l.draw_editor(self,n,ix.gui.vendor.entity)end end end function c:OnRemove()if(IsValid(ix.gui.vendor))then ix.gui.vendor:Remove()end if(IsValid(ix.gui.editorFaction))then ix.gui.editorFaction:Remove()end end function c:updateVendor(d,e)net.Start("dialogSystem_EditVendor")net.WriteString(d)net.WriteType(e)net.SendToServer()end vgui.Register("dialogs.admin-menu.vendor",c,"DFrame")